# 管理员账户设置指南

## 🚀 快速开始

### 步骤 1：创建管理员账户

使用提供的脚本创建管理员账户：

```bash
# 使用 tsx 运行脚本
tsx scripts/create-admin.ts admin admin123456

# 或者使用 pnpm
pnpm exec tsx scripts/create-admin.ts admin admin123456
```

**参数说明：**
- `admin` - 管理员用户名（至少3个字符）
- `admin123456` - 管理员密码（至少6个字符）

**示例输出：**
```
✅ 管理员账户创建成功！

账户信息:
  用户名: admin
  ID: 1
  创建时间: 2025-01-27T10:00:00.000Z

💡 提示:
   现在可以使用此账户登录管理后台
   登录地址: /pages/admin/login/index
```

### 步骤 2：登录管理后台

1. **在小程序中访问登录页面**
   - 路径：`/pages/admin/login/index`
   - 或在小程序中直接导航到管理员登录页面

2. **输入账户信息**
   - 用户名：刚才创建的用户名（如：`admin`）
   - 密码：刚才设置的密码（如：`admin123456`）

3. **登录成功后**
   - 自动跳转到管理后台首页
   - 可以查看各种统计数据

## 📊 管理后台功能

### 1. 数据统计

- **总测评数**：所有测评记录的总数
- **今日新增**：今天新增的测评记录数
- **用户总数**：去重后的用户总数

### 2. 体质类型分布

显示各种体质类型的分布情况，包括：
- 各体质类型的数量
- 可视化进度条显示占比

### 3. 性别分布

显示男女用户的分布情况

### 4. 测评记录列表

显示最近的测评记录，包括：
- 体质类型
- 用户年龄和性别
- 创建时间

### 5. 数据导出

- 点击"导出CSV数据"按钮
- 数据会复制到剪贴板
- 可以粘贴到Excel或其他工具中分析

## 🔧 技术实现

### 数据库表结构

管理员账户存储在 `admin_users` 表中：
- `id`: 主键
- `username`: 用户名（唯一）
- `password`: 加密后的密码（bcrypt）
- `createdAt`: 创建时间
- `lastLoginAt`: 最后登录时间

### 认证机制

1. **登录流程**：
   - 前端发送用户名和密码到 `/api/admin/login`
   - 后端验证密码（使用 bcrypt 比较）
   - 设置 `admin_id` cookie（7天有效期）

2. **权限验证**：
   - 通过 cookie 中的 `admin_id` 识别管理员
   - 在 tRPC context 中自动创建 admin user
   - 所有 admin 接口需要 `user.role === 'admin'`

### API 接口

#### REST API（用于登录）

- `POST /api/admin/login` - 管理员登录
- `GET /api/admin/check` - 检查登录状态
- `POST /api/admin/logout` - 退出登录

#### tRPC API（用于数据查询）

- `assessment.stats` - 获取统计数据
- `assessment.all` - 获取所有测评记录
- `assessment.getById` - 获取单条测评记录

## ⚠️ 注意事项

### 1. 安全性

- ⚠️ **密码安全**：使用强密码（至少6个字符，建议包含字母、数字）
- ⚠️ **不要共享账户**：每个管理员应该有自己的账户
- ⚠️ **定期更换密码**：建议定期更换管理员密码

### 2. 首次创建

- 如果系统中已有管理员账户，脚本会拒绝创建
- 需要先删除现有管理员或使用不同的用户名

### 3. 数据库要求

- 确保数据库连接正常
- 确保 `admin_users` 表已创建（运行数据库迁移）

### 4. 小程序环境

- 确保 API 服务器地址配置正确（`TARO_APP_API_URL`）
- 开发环境可以使用 `http://localhost:3000`
- 生产环境需要配置实际服务器地址

## 🐛 常见问题

### Q1: 脚本执行失败，提示"数据库连接失败"

**解决**：
1. 检查 `.env` 文件中的 `DATABASE_URL` 配置
2. 确保数据库服务正在运行
3. 检查数据库连接字符串格式

### Q2: 提示"管理员账户已存在"

**解决**：
1. 如果确实需要创建新账户，先删除现有管理员
2. 或者使用不同的用户名

### Q3: 登录后无法查看数据

**解决**：
1. 检查浏览器/小程序是否支持 cookie
2. 检查 API 服务器是否正常运行
3. 查看控制台错误信息

### Q4: 统计数据不准确

**解决**：
1. 检查数据库中的测评记录
2. 确保 `assessments` 表有数据
3. 检查统计逻辑是否正确

## 📝 相关文件

- 创建脚本：`scripts/create-admin.ts`
- 认证逻辑：`server/admin-auth.ts`
- 登录接口：`server/api/admin-auth.ts`
- 管理页面：`src/pages/admin/index.tsx`
- 登录页面：`src/pages/admin/login/index.tsx`
- 统计数据：`server/assessments.ts` (getAssessmentStats)

## 🔗 下一步

创建管理员账户后，你可以：
1. 登录管理后台查看数据
2. 导出数据进行进一步分析
3. 根据需要添加更多管理功能
