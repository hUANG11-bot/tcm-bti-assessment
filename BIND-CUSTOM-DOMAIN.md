# 绑定自定义域名到云托管

## 📋 前提条件

- ✅ 您已经有一个域名
- ✅ 域名已通过ICP备案（国内服务器）
- ✅ 可以配置DNS解析

## 🚀 绑定步骤

### 步骤1：进入云托管自定义域名页面

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **进入云托管**
   - 点击左侧菜单：**云服务**
   - 选择：**云开发**
   - 点击：**云托管** 标签

3. **进入服务管理**
   - 找到您的云托管服务
   - 点击服务名称进入详情页

4. **进入自定义域名页面**
   - 在服务管理页面，点击 **"自定义域名"**
   - 或从左侧菜单：**服务管理** → **自定义域名**

### 步骤2：绑定域名

1. **点击"绑定域名"按钮**
   - 在自定义域名页面，点击绿色的 **"绑定域名"** 按钮

2. **输入您的域名**
   - 输入您的域名（例如：`api.yourdomain.com` 或 `er1.store`）
   - **注意**：
     - 可以输入主域名（如：`er1.store`、`yourdomain.com`）
     - 也可以输入子域名（如：`api.er1.store`、`api.yourdomain.com`，推荐）
     - 不要包含 `https://` 前缀
     - 不要包含端口号
     - 不要包含路径（如 `/api`）

3. **查看DNS配置要求**
   - 系统会显示需要配置的DNS记录
   - 通常是CNAME记录
   - 记录值类似：`xxx.cloudbaseapp.com`

### 步骤3：配置DNS解析

1. **登录您的域名服务商**
   - 例如：腾讯云、阿里云、GoDaddy等
   - 进入域名管理控制台

2. **添加DNS记录**
   - 找到DNS解析设置
   - 添加一条 **CNAME记录**：
     - **主机记录**：`api`（如果使用 `api.yourdomain.com`）
     - **记录类型**：`CNAME`
     - **记录值**：云托管提供的CNAME值（如：`xxx.cloudbaseapp.com`）
     - **TTL**：默认或600

   **示例**：
   ```
   主机记录: api
   记录类型: CNAME
   记录值: express-w0qu-184647-5-1377481866.sh.run.tcloudbase.com
   ```

3. **等待DNS生效**
   - DNS解析通常需要几分钟到几小时
   - 可以使用 `nslookup` 或在线工具检查是否生效

### 步骤4：等待域名验证

1. **返回云托管页面**
   - 配置DNS后，返回云托管自定义域名页面
   - 系统会自动验证域名

2. **等待HTTPS证书配置**
   - 域名验证通过后，系统会自动配置HTTPS证书
   - 这个过程可能需要几分钟到几十分钟

3. **查看绑定状态**
   - 在自定义域名列表中查看状态
   - 状态显示为"已绑定"或"正常"表示成功

### 步骤5：配置服务器域名

1. **登录微信公众平台**
   - 进入：**开发** → **开发管理** → **开发设置**

2. **配置request合法域名**
   - 找到 **"服务器域名"** 部分
   - 点击 **"修改"** 按钮
   - 在 **"request合法域名"** 中添加您的自定义域名：
     ```
     https://api.yourdomain.com
     ```
   - **注意**：必须包含 `https://` 前缀

3. **保存配置**
   - 点击"保存"或"提交"
   - 配置通常立即生效

### 步骤6：更新小程序配置

1. **更新编译配置**
   ```bash
   # 使用自定义域名编译
   set TARO_APP_API_URL=https://api.yourdomain.com && pnpm build:weapp
   ```

2. **或者更新 .env 文件**
   ```env
   TARO_APP_API_URL=https://api.yourdomain.com
   ```
   然后编译：
   ```bash
   pnpm build:weapp
   ```

3. **清除缓存并重新编译**
   - 删除 `dist` 目录
   - 重新编译小程序

### 步骤7：测试功能

1. **在浏览器中测试**
   - 访问：`https://api.yourdomain.com`
   - 确认可以访问（可能显示错误页面，但不应该显示"无法连接"）

2. **在小程序中测试**
   - 重新编译并加载小程序
   - 测试微信登录功能
   - 测试AI中医功能

## 📋 完整检查清单

### DNS配置
- [ ] 已在域名服务商添加CNAME记录
- [ ] DNS记录值正确（云托管提供的CNAME值）
- [ ] DNS解析已生效（可以使用nslookup检查）

### 云托管配置
- [ ] 已在云托管中绑定域名
- [ ] 域名状态显示为"已绑定"或"正常"
- [ ] HTTPS证书已自动配置

### 微信公众平台配置
- [ ] 已在"request合法域名"中添加自定义域名
- [ ] 域名格式正确（`https://api.yourdomain.com`）

### 小程序配置
- [ ] 已使用自定义域名重新编译小程序
- [ ] 已清除缓存
- [ ] 已重新加载小程序

### 功能测试
- [ ] 浏览器可以访问API地址
- [ ] 微信登录功能正常
- [ ] AI中医功能正常

## 🔧 常见问题

### Q1: DNS解析需要多长时间？

**A**: 
- 通常几分钟到几小时
- 最长可能需要24-48小时
- 可以使用在线工具检查DNS是否生效

### Q2: 如何检查DNS是否生效？

**A**: 
使用以下命令检查：
```bash
# Windows
nslookup api.yourdomain.com

# 或使用在线工具
# https://dnschecker.org/
```

### Q3: 可以使用主域名吗？

**A**: 
- 可以，但推荐使用子域名（如：`api.yourdomain.com`）
- 使用子域名的好处：
  - 不影响主域名的其他服务
  - 更灵活，可以单独管理

### Q4: 绑定失败怎么办？

**A**: 
1. **检查DNS配置**：
   - 确认CNAME记录已正确添加
   - 确认DNS解析已生效

2. **检查域名备案**：
   - 国内服务器必须备案
   - 未备案的域名无法绑定

3. **检查域名格式**：
   - 不要包含 `https://`
   - 不要包含端口号
   - 不要包含路径

4. **联系云开发客服**：
   - 如果以上都正确，联系云开发技术支持

### Q5: HTTPS证书需要自己配置吗？

**A**: 
- 不需要，云托管会自动配置HTTPS证书
- 绑定域名后，系统会自动申请和配置证书
- 通常需要几分钟到几十分钟

### Q6: 可以绑定多个域名吗？

**A**: 
- 可以，云托管支持绑定多个自定义域名
- 每个域名都需要单独配置DNS解析

## 💡 推荐配置

### 推荐使用子域名

**推荐**：
```
api.yourdomain.com
```

**不推荐**：
```
yourdomain.com（主域名）
```

**原因**：
- 子域名更灵活
- 不影响主域名的其他服务
- 可以单独管理

### 域名示例

假设您的域名是 `example.com`：

**推荐配置**：
```
request合法域名：
https://api.example.com
```

**编译命令**：
```bash
set TARO_APP_API_URL=https://api.example.com && pnpm build:weapp
```

## 🚀 快速开始

### 1. 在云托管中绑定域名

1. 进入：**云服务** → **云开发** → **云托管** → **服务管理** → **自定义域名**
2. 点击"绑定域名"
3. 输入您的域名（如：`api.yourdomain.com`）
4. 复制CNAME记录值

### 2. 配置DNS解析

1. 登录域名服务商
2. 添加CNAME记录：
   - 主机记录：`api`
   - 记录值：云托管提供的CNAME值
3. 等待DNS生效

### 3. 等待域名验证

1. 返回云托管页面
2. 等待域名验证和HTTPS证书配置完成
3. 确认状态为"已绑定"

### 4. 配置服务器域名

1. 微信公众平台 → **开发** → **开发管理** → **开发设置**
2. 在"request合法域名"中添加：`https://api.yourdomain.com`

### 5. 重新编译小程序

```bash
set TARO_APP_API_URL=https://api.yourdomain.com && pnpm build:weapp
```

### 6. 测试功能

在小程序中测试所有功能是否正常。

## 📞 需要帮助？

如果遇到问题：

1. **DNS配置问题**：联系您的域名服务商
2. **域名绑定问题**：查看云托管文档或联系云开发客服
3. **功能测试问题**：查看其他故障排除文档
