# 云托管部署配置指南

## 📋 当前步骤：配置代码部署

您正在配置将后端代码部署到微信云托管。有两种方式：

1. **GitHub仓库绑定**（自动部署）
2. **手动上传代码包**（推荐，更简单）

---

## 🎯 选择部署方式

### 方式1：手动上传代码包（推荐）

**优点**：
- ✅ 不需要GitHub授权
- ✅ 直接上传本地代码
- ✅ 更快速、更简单

**详细步骤**：请查看 [MANUAL-UPLOAD-GUIDE.md](./MANUAL-UPLOAD-GUIDE.md)

**快速开始**：
1. 构建代码：`pnpm build`
2. 创建压缩包（包含 `dist/`、`server/`、`shared/`、`package.json`、`pnpm-lock.yaml`）
3. 在云托管页面选择"上传代码包"
4. 上传压缩包，设置端口为 `3000`
5. 点击发布

---

### 方式2：GitHub仓库绑定

**如果您想使用GitHub自动部署，按照以下步骤：**

## 🚀 部署配置步骤（GitHub方式）

### 步骤1：完成GitHub授权（必须）

**当前状态**：显示"代码权限未授权或授权过期"

**操作步骤**：

1. **点击红色提示中的"点击授权"链接**
   - 页面会跳转到GitHub授权页面

2. **在GitHub授权页面**：
   - 登录您的GitHub账号（如果未登录）
   - 确认授权微信云托管访问您的仓库
   - 选择要授权的仓库范围（建议选择"所有仓库"或指定仓库）

3. **授权成功后**：
   - 自动返回云托管页面
   - 红色提示消失
   - "代码仓库"下拉菜单可以正常使用

---

### 步骤2：选择代码仓库

**操作步骤**：

1. **点击"代码仓库"下拉菜单**
   - 现在应该可以看到您的GitHub仓库列表

2. **选择您的项目仓库**
   - 找到包含 `tcm-bti-assessment` 项目的仓库
   - 仓库名称通常是：`您的用户名/tcm-bti-assessment` 或类似格式

3. **确认选择**
   - 选择后，仓库名称会显示在下拉菜单中

---

### 步骤3：选择分支

**操作步骤**：

1. **点击"分支"下拉菜单**
   - 选择代码仓库后，这里会显示该仓库的所有分支

2. **选择要部署的分支**
   - 通常选择：`main` 或 `master`（主分支）
   - 如果使用其他分支（如 `dev`、`production`），选择对应的分支

3. **确认选择**
   - 选择后，分支名称会显示在下拉菜单中

---

### 步骤4：设置端口（重要）

**当前显示**：端口输入框显示 `80`

**需要修改为**：`3000`

**操作步骤**：

1. **点击端口输入框**
   - 清空当前的 `80`

2. **输入**：`3000`
   - 这是您的Node.js后端服务监听的端口
   - 代码中默认使用 `process.env.PORT || "3000"`

3. **确认输入**
   - 确保输入框显示为 `3000`

**为什么是3000？**
- 您的服务器代码（`server/_core/index.ts`）默认监听3000端口
- 云托管会通过环境变量 `PORT` 传递端口号
- 如果云托管自动设置 `PORT` 环境变量，代码会使用该值
- 但为了确保正确，建议明确设置为 `3000`

---

### 步骤5：高级设置（可选）

**如果需要配置环境变量**：

1. **展开"高级设置"**
   - 点击"高级设置"展开配置选项

2. **配置环境变量**
   - 找到"环境变量"或"配置"选项
   - 添加以下环境变量：

   ```env
   WX_APPID=您的微信小程序AppID
   WX_SECRET=您的微信小程序AppSecret
   AI_PROVIDER=deepseek
   AI_API_KEY=您的DeepSeek API密钥
   JWT_SECRET=您的JWT密钥（随机字符串）
   NODE_ENV=production
   PORT=3000
   ```

   **注意**：
   - 如果"高级设置"中没有环境变量配置，可以在部署后到"服务设置"中配置
   - 环境变量也可以在部署完成后配置（见步骤6）

3. **其他高级设置**
   - 构建命令：通常不需要修改，使用默认即可
   - 启动命令：通常不需要修改，使用默认即可

---

### 步骤6：发布部署

**操作步骤**：

1. **检查所有配置**
   - ✅ GitHub已授权
   - ✅ 代码仓库已选择
   - ✅ 分支已选择
   - ✅ 端口设置为 `3000`
   - ✅ 环境变量已配置（可选，也可部署后配置）

2. **点击绿色的"发布"按钮**
   - 开始部署流程

3. **等待部署完成**
   - 部署过程可能需要几分钟
   - 可以查看部署日志了解进度
   - 部署成功后，服务会自动启动

---

## 📋 部署后配置

### 配置环境变量（如果部署时未配置）

**如果部署时没有配置环境变量，部署后需要配置**：

1. **进入服务管理**
   - 部署完成后，进入服务详情页

2. **找到"环境变量"或"配置"选项**
   - 通常在"服务设置"或"配置"标签中

3. **添加环境变量**
   ```env
   WX_APPID=您的微信小程序AppID
   WX_SECRET=您的微信小程序AppSecret
   AI_PROVIDER=deepseek
   AI_API_KEY=您的DeepSeek API密钥
   JWT_SECRET=您的JWT密钥（随机字符串）
   NODE_ENV=production
   PORT=3000
   ```

4. **保存并重启服务**
   - 保存环境变量后，需要重启服务使配置生效
   - 在服务管理页面点击"重启"按钮

---

### 获取API地址

**部署成功后**：

1. **查看服务地址**
   - 在服务管理页面找到"访问地址"或"域名"
   - 格式类似：`https://服务名-环境ID.cloudbaseapp.com`
   - 或：`https://服务名-xxx.sh.run.tcloudbase.com`

2. **记录API地址**
   - 这就是您的小程序需要连接的API地址
   - 后续需要：
     - 在微信公众平台配置为"request合法域名"
     - 在小程序编译时使用该地址

---

## 🔧 常见问题

### Q1: GitHub授权失败怎么办？

**A**: 
1. **检查GitHub账号**：
   - 确认GitHub账号可以正常登录
   - 确认有仓库的访问权限

2. **重新授权**：
   - 清除浏览器缓存
   - 重新点击"点击授权"
   - 在GitHub授权页面确认授权

3. **检查仓库权限**：
   - 如果仓库是私有的，确保GitHub账号有访问权限
   - 如果是组织仓库，确保有组织权限

---

### Q2: 找不到代码仓库怎么办？

**A**: 
1. **检查GitHub授权**：
   - 确认授权成功
   - 确认授权时选择了正确的仓库范围

2. **检查仓库名称**：
   - 确认仓库名称正确
   - 尝试刷新页面

3. **使用CLI工具**：
   - 如果私有仓库无法通过网页授权，可以使用CLI工具部署
   - 参考云托管CLI文档

---

### Q3: 端口应该设置多少？

**A**: 
- **推荐**：`3000`
- **原因**：
  - 您的服务器代码默认监听3000端口
  - 云托管通常会自动设置 `PORT` 环境变量
  - 但明确设置为3000更保险

**其他常见端口**：
- `80`：HTTP默认端口（不推荐，云托管通常不使用）
- `8080`：备用HTTP端口（如果3000不可用）
- `443`：HTTPS默认端口（云托管自动处理）

---

### Q4: 部署失败怎么办？

**A**: 
1. **查看部署日志**：
   - 在部署页面查看详细日志
   - 查找错误信息

2. **检查代码**：
   - 确认代码仓库和分支正确
   - 确认代码可以正常构建

3. **检查环境变量**：
   - 确认必需的环境变量已配置
   - 确认环境变量值正确

4. **检查端口**：
   - 确认端口设置正确（3000）

---

### Q5: 如何查看部署日志？

**A**: 
1. **部署过程中**：
   - 在部署页面可以看到实时日志

2. **部署完成后**：
   - 进入服务管理页面
   - 点击"运行日志"或"日志"标签
   - 查看服务运行日志

---

### Q6: 环境变量在哪里配置？

**A**: 
**方式1：部署时配置**
- 在"高级设置"中配置（如果可用）

**方式2：部署后配置（推荐）**
- 进入服务管理页面
- 找到"服务设置"或"配置"标签
- 添加环境变量
- 保存后重启服务

---

## ✅ 完整检查清单

### 部署前
- [ ] GitHub已授权
- [ ] 代码仓库已选择
- [ ] 分支已选择（通常是 `main` 或 `master`）
- [ ] 端口设置为 `3000`
- [ ] 环境变量已准备（WX_APPID、WX_SECRET、AI_API_KEY等）

### 部署后
- [ ] 部署成功，服务正常运行
- [ ] 环境变量已配置（如果部署时未配置）
- [ ] 服务已重启（如果修改了环境变量）
- [ ] 已获取API地址
- [ ] 已查看运行日志，确认无错误

### 后续配置
- [ ] 已在微信公众平台配置"request合法域名"
- [ ] 已使用API地址重新编译小程序
- [ ] 已测试微信登录功能
- [ ] 已测试AI中医功能

---

## 🚀 快速开始

### 1. 完成GitHub授权
点击红色提示中的"点击授权"，完成GitHub授权。

### 2. 选择代码仓库和分支
- 代码仓库：选择包含 `tcm-bti-assessment` 的仓库
- 分支：选择 `main` 或 `master`

### 3. 设置端口
将端口从 `80` 改为 `3000`

### 4. 点击发布
点击绿色的"发布"按钮，等待部署完成。

### 5. 配置环境变量
部署后，在服务设置中配置环境变量（WX_APPID、WX_SECRET、AI_API_KEY等）。

### 6. 获取API地址
记录服务访问地址，用于后续配置。

---

## 📞 需要帮助？

如果遇到问题：

1. **GitHub授权问题**：检查GitHub账号和权限
2. **部署失败**：查看部署日志，检查代码和配置
3. **服务无法启动**：查看运行日志，检查环境变量和端口
4. **其他问题**：查看云托管文档或联系云开发客服
