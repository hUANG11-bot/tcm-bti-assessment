# 微信云开发环境配置指南

## 📋 概述

如果您使用微信云开发来部署后端服务，配置方式与普通服务器部署有所不同。本指南将帮助您正确配置云开发环境。

## 🔍 确认云开发环境

从您的截图可以看到：
- **环境名称**：`cloud1`
- **环境ID**：`cloud1-0g2dym0r58f17842`

## ⚠️ 重要说明

**当前项目架构**：
- 本项目使用的是 **独立后端服务器**（Node.js + Express）
- 不是微信云开发的云函数架构

**两种部署方案**：

### 方案A：使用云开发云函数（需要改造）

如果要在云开发中运行，需要：
1. 将后端代码改造为云函数
2. 在云开发控制台配置环境变量
3. 使用云开发的API地址

### 方案B：使用云托管（推荐）

微信云开发提供"云托管"服务，可以直接部署Node.js应用：
1. 在云开发控制台创建云托管服务
2. 上传后端代码
3. 配置环境变量
4. 获取云托管的访问地址

## 🚀 方案B：使用云托管（推荐）

### 步骤1：创建云托管服务

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com
   - 进入：**云服务** → **云开发** → **云托管**

2. **创建服务**
   - 点击"新建服务"
   - 填写服务名称（如：`tcm-api`）
   - 选择环境：`cloud1`

3. **获取访问地址**
   - 创建后会获得一个访问地址
   - 格式类似：`https://tcm-api-xxx.cloudbaseapp.com`
   - 这就是您的API地址

### 步骤2：配置环境变量

在云托管服务中配置环境变量：

1. **进入服务管理**
   - 点击服务名称进入管理页面
   - 找到"环境变量"或"配置"选项

2. **添加环境变量**
   ```env
   WX_APPID=wx04a7af67c8f47620
   WX_SECRET=你的AppSecret
   AI_PROVIDER=deepseek
   AI_API_KEY=你的DeepSeek密钥
   JWT_SECRET=你的JWT密钥
   NODE_ENV=production
   ```

3. **保存配置**
   - 保存后需要重启服务使配置生效

### 步骤3：部署后端代码

1. **准备部署文件**
   - 确保后端代码可以独立运行
   - 检查 `package.json` 中的启动脚本

2. **上传代码**
   - 在云托管服务中点击"上传代码"
   - 选择项目目录或打包后的代码
   - 等待部署完成

3. **查看日志**
   - 部署后查看服务日志
   - 确认服务正常启动

### 步骤4：配置小程序API地址

1. **获取云托管地址**
   - 从云托管服务管理页面获取访问地址
   - 例如：`https://tcm-api-xxx.cloudbaseapp.com`

2. **更新小程序配置**
   ```bash
   # 使用云托管地址编译小程序
   set TARO_APP_API_URL=https://tcm-api-xxx.cloudbaseapp.com && pnpm build:weapp
   ```

3. **配置服务器域名**
   - 登录微信公众平台
   - 进入：**开发** → **开发管理** → **开发设置**
   - 在 **"request合法域名"** 中添加云托管地址
   - 例如：`https://tcm-api-xxx.cloudbaseapp.com`

### 步骤5：测试功能

1. **测试微信登录**
   - 在小程序中点击"微信一键登录"
   - 查看是否成功

2. **测试AI功能**
   - 完成测评后进入AI中医咨询
   - 发送测试消息
   - 查看是否正常回复

## 🔧 方案A：使用云函数（需要代码改造）

如果您想使用云函数而不是云托管，需要：

### 1. 改造后端代码

将现有的Express路由改造为云函数：

```javascript
// cloudfunctions/login/index.js
const cloud = require('wx-server-sdk')
cloud.init({
  env: 'cloud1-0g2dym0r58f17842'
})

exports.main = async (event, context) => {
  // 微信登录逻辑
  const { code } = event
  // ... 处理登录
}
```

### 2. 配置云函数环境变量

在云开发控制台：
- 进入：**云函数** → 选择函数 → **配置**
- 添加环境变量

### 3. 调用云函数

在小程序中调用：
```javascript
wx.cloud.callFunction({
  name: 'login',
  data: { code: 'xxx' }
})
```

**注意**：这个方案需要大量代码改造，不推荐。

## 📋 云开发配置检查清单

### 云托管配置
- [ ] 已创建云托管服务
- [ ] 已获取云托管访问地址
- [ ] 已配置环境变量（WX_APPID、WX_SECRET、AI_API_KEY等）
- [ ] 后端代码已部署
- [ ] 服务正常运行（查看日志确认）

### 小程序配置
- [ ] 已使用云托管地址编译小程序
- [ ] 已在微信公众平台配置服务器域名
- [ ] 服务器域名使用HTTPS
- [ ] 小程序已重新上传

### 功能测试
- [ ] 微信登录功能正常
- [ ] AI中医功能正常
- [ ] 其他功能正常

## 🔍 常见问题

### Q1: 云托管地址是什么格式？

**A**: 云托管地址格式：
```
https://服务名-环境ID.cloudbaseapp.com
```

例如：
```
https://tcm-api-cloud1-0g2dym0r58f17842.cloudbaseapp.com
```

### Q2: 如何查看云托管日志？

**A**: 
1. 进入云开发控制台
2. 选择云托管服务
3. 点击"日志"或"监控"
4. 查看实时日志

### Q3: 环境变量在哪里配置？

**A**: 
- **云托管**：在服务管理页面的"环境变量"或"配置"中
- **云函数**：在云函数管理页面的"配置"中

### Q4: 如何重启云托管服务？

**A**:
1. 进入服务管理页面
2. 点击"重启"或"重新部署"
3. 等待重启完成

### Q5: 云托管和云函数有什么区别？

**A**:
- **云托管**：可以运行完整的Node.js应用，适合现有项目
- **云函数**：需要将代码改造为函数形式，适合新项目

## 💡 推荐方案

**推荐使用云托管**，因为：
1. ✅ 不需要改造现有代码
2. ✅ 可以直接部署Node.js应用
3. ✅ 配置更简单
4. ✅ 更容易调试和维护

## 📞 获取帮助

如果遇到问题：

1. **查看云开发文档**
   - 云托管文档：https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html

2. **查看服务日志**
   - 在云开发控制台查看详细日志

3. **检查环境变量**
   - 确认所有必需的环境变量都已配置

4. **测试API地址**
   - 使用浏览器或curl测试云托管地址是否可访问
