# 配置数据库连接字符串

## ✅ 数据库连接字符串

您提供的连接字符串：
```
mysql://root:Huangte991%2C%2C@sh-cdb-pvaed2ys.sql.tencentcdb.com:23371/tcm_bti_assessment
```

**解析**：
- **用户名**：`root`
- **密码**：`Huangte991,,`（已正确 URL 编码为 `Huangte991%2C%2C`）
- **主机**：`sh-cdb-pvaed2ys.sql.tencentcdb.com`
- **端口**：`23371`
- **数据库**：`tcm_bti_assessment`

**格式正确** ✅

---

## 📝 在微信云托管中配置步骤

### 步骤1：进入服务设置

1. **登录微信云托管控制台**
2. **进入服务管理** → **服务列表**
3. **点击您的服务名称**（如 `tci`）
4. **点击"服务设置"标签**

---

### 步骤2：添加环境变量

1. **找到"环境变量"部分**
2. **点击"添加环境变量"**（或"编辑"按钮）
3. **添加以下环境变量**：

#### 变量名：`DATABASE_URL`

#### 变量值：
```
mysql://root:Huangte991%2C%2C@sh-cdb-pvaed2ys.sql.tencentcdb.com:23371/tcm_bti_assessment
```

**注意**：
- 直接复制粘贴整个连接字符串
- 不要修改任何字符
- 确保没有多余的空格

---

### 步骤3：保存配置

1. **点击"保存"按钮**
2. **确认环境变量已添加**

---

### 步骤4：重新部署服务

1. **返回"部署发布"页面**
2. **点击"发布"按钮**
3. **等待部署完成**

---

### 步骤5：验证数据库连接

1. **查看服务运行日志**
2. **查看是否有数据库连接错误**
3. **如果连接成功，应该看到服务正常启动**

---

## 🔍 验证方法

### 方法1：查看运行日志

1. **在微信云托管控制台**
2. **进入服务详情** → **运行日志**
3. **查看是否有数据库连接相关的错误**

**成功标志**：
- 没有数据库连接错误
- 服务正常启动
- 可以看到应用日志

**失败标志**：
- `ECONNREFUSED`：无法连接到数据库
- `ER_ACCESS_DENIED_ERROR`：用户名或密码错误
- `ER_BAD_DB_ERROR`：数据库不存在

---

### 方法2：测试数据库连接（本地）

如果您在本地有项目代码，可以运行：

```bash
pnpm test-db
```

这会测试数据库连接是否正常。

---

## ⚠️ 重要注意事项

### 关于密码编码

- ✅ **已正确编码**：`%2C%2C` 是 `,,` 的 URL 编码
- ✅ **格式正确**：连接字符串格式符合标准

---

### 关于数据库访问

- **外网地址**：`sh-cdb-pvaed2ys.sql.tencentcdb.com:23371` 是外网地址
- **端口**：`23371` 是外网端口（不是标准的 3306）
- **安全组**：确保数据库安全组允许微信云托管访问

---

### 关于数据库名称

- **数据库名**：`tcm_bti_assessment`
- **必须存在**：确保这个数据库已经在数据库实例中创建

---

## 📋 完整的环境变量清单

确保以下环境变量都已配置：

### 必需的环境变量：

```
WX_APPID=wx04a7af67c8f47620
WX_SECRET=你的微信AppSecret
JWT_SECRET=你的JWT密钥（至少32个字符）
DATABASE_URL=mysql://root:Huangte991%2C%2C@sh-cdb-pvaed2ys.sql.tencentcdb.com:23371/tcm_bti_assessment
AI_API_KEY=你的AI API密钥
```

### 可选的环境变量：

```
AI_PROVIDER=deepseek（默认值）
AI_API_URL=（可选，DeepSeek不需要）
PORT=3000（默认值）
NODE_ENV=production（默认值）
```

---

## 🎯 现在请

1. **在微信云托管控制台中配置环境变量**：
   - 添加 `DATABASE_URL` 环境变量
   - 值：`mysql://root:Huangte991%2C%2C@sh-cdb-pvaed2ys.sql.tencentcdb.com:23371/tcm_bti_assessment`

2. **保存配置**

3. **重新部署服务**

4. **查看运行日志**：
   - 确认数据库连接成功
   - 确认服务正常启动

5. **如果还有问题**：
   - 查看具体的错误信息
   - 告诉我错误详情

---

## 💡 提示

- **连接字符串格式正确**：已正确 URL 编码
- **外网地址**：使用外网地址，微信云托管可以访问
- **需要重新部署**：修改环境变量后必须重新部署服务
- **查看日志**：如果连接失败，查看运行日志了解具体错误

**请按照上述步骤配置，然后告诉我结果！**
