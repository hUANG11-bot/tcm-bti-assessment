# AI 无法使用 - 故障排查指南

## 🚨 问题现象

**错误信息**：`无法连接到服务器 请检查: 1. 后端服务是否运行`

这说明小程序无法连接到后端服务。

---

## 🔍 排查步骤

### 步骤1：检查服务是否运行

1. **进入微信云托管控制台**
2. **服务管理** → **服务列表**
3. **找到您的服务**（如 `tci-001` 或 `zhongyiti-022`）
4. **查看服务状态**：
   - ✅ **正常运行**：实例数量 > 0
   - ❌ **未运行**：实例数量 = 0（自动暂停）

**如果服务未运行**：
- 点击"部署发布"标签
- 点击"发布"按钮启动服务
- 等待实例启动（1-2 分钟）

---

### 步骤2：检查运行日志

1. **点击"运行日志"标签**
2. **查看最近的日志**
3. **查找错误信息**

**常见错误**：

#### 错误1：环境变量缺失
```
Error: Missing required environment variable: DATABASE_URL
```
**解决**：在"服务设置"中添加缺失的环境变量

#### 错误2：数据库连接失败
```
Error: connect ECONNREFUSED
Error: Access denied
```
**解决**：检查 `DATABASE_URL` 是否正确，数据库是否可访问

#### 错误3：服务启动失败
```
Error: Cannot find package 'xxx'
```
**解决**：检查依赖是否完整

---

### 步骤3：检查环境变量配置

1. **点击"服务设置"标签**
2. **找到"环境变量"部分**
3. **确认以下必需变量已配置**：

#### 必需环境变量清单

- [ ] `DATABASE_URL` - 数据库连接字符串
- [ ] `WX_APPID` - 微信 AppID
- [ ] `WX_SECRET` - 微信 AppSecret
- [ ] `JWT_SECRET` - JWT 密钥
- [ ] `AI_API_KEY` - AI API 密钥

#### 可选环境变量

- [ ] `AI_PROVIDER` - AI 服务提供商（默认：deepseek）
- [ ] `AI_API_URL` - AI API URL（如果需要）
- [ ] `NODE_ENV` - 环境（默认：production）

---

### 步骤4：检查数据库连接

如果 `DATABASE_URL` 已配置，但服务仍无法连接：

1. **检查数据库是否创建**
   - 在腾讯云控制台查看数据库实例状态
   - 确认数据库实例已创建并运行

2. **检查数据库是否可访问**
   - 确认安全组规则允许连接
   - 确认白名单配置正确

3. **检查连接字符串格式**
   ```
   mysql://用户名:密码@主机:3306/数据库名
   ```
   - 确认格式正确
   - 确认密码中的特殊字符已正确编码

---

### 步骤5：检查服务配置

1. **点击"服务设置"标签**
2. **检查实例配置**：
   - **最小实例数**：至少 1
   - **CPU**：至少 0.5 核
   - **内存**：至少 512MB（推荐 1GB）

---

## 🔧 快速修复步骤

### 如果服务未运行

1. **启动服务**：
   - 进入"部署发布"页面
   - 点击"发布"按钮
   - 等待实例启动

2. **检查运行日志**：
   - 查看是否有错误信息
   - 如果有错误，根据错误信息修复

---

### 如果环境变量缺失

1. **进入"服务设置"**
2. **添加缺失的环境变量**：
   - `DATABASE_URL`（如果还没有数据库，先创建数据库）
   - `WX_APPID`
   - `WX_SECRET`
   - `JWT_SECRET`
   - `AI_API_KEY`

3. **保存配置**
4. **重新部署服务**

---

### 如果数据库连接失败

1. **检查数据库是否创建**：
   - 如果还没创建，先完成数据库创建流程

2. **检查连接字符串**：
   - 格式：`mysql://用户名:密码@主机:3306/数据库名`
   - 确认所有信息正确

3. **检查安全组和白名单**：
   - 确保允许微信云托管访问数据库

---

## 📋 完整检查清单

在排查问题时，请确认：

### 服务状态
- [ ] 服务实例数量 > 0（服务正在运行）
- [ ] 服务状态显示"正常"

### 环境变量
- [ ] `DATABASE_URL` 已配置（如果使用数据库功能）
- [ ] `WX_APPID` 已配置
- [ ] `WX_SECRET` 已配置
- [ ] `JWT_SECRET` 已配置
- [ ] `AI_API_KEY` 已配置

### 数据库（如果使用）
- [ ] 数据库实例已创建
- [ ] 数据库已创建（如：`tcm_bti_assessment`）
- [ ] 安全组规则允许连接
- [ ] 白名单配置正确

### 运行日志
- [ ] 没有错误信息
- [ ] 服务正常启动（看到 "Server started on port 3000" 等）

---

## 🎯 现在请

1. **检查服务状态**：
   - 进入微信云托管控制台
   - 查看服务是否运行（实例数量 > 0）

2. **如果服务未运行**：
   - 点击"发布"按钮启动服务

3. **如果服务运行但仍有错误**：
   - 查看"运行日志"
   - 告诉我具体的错误信息

4. **检查环境变量**：
   - 进入"服务设置"
   - 确认所有必需的环境变量已配置

---

## 💡 常见问题

### Q1：服务显示"0个实例 (自动暂停)"

**原因**：服务未启动

**解决**：
1. 点击"发布"按钮启动服务
2. 检查最小实例数是否设置为至少 1

---

### Q2：运行日志显示数据库连接错误

**原因**：数据库未配置或连接失败

**解决**：
1. 检查 `DATABASE_URL` 是否配置
2. 如果还没创建数据库，先完成数据库创建
3. 检查连接字符串格式是否正确

---

### Q3：运行日志显示环境变量缺失

**原因**：必需的环境变量未配置

**解决**：
1. 进入"服务设置"
2. 添加缺失的环境变量
3. 保存并重新部署

---

### Q4：服务启动但 AI 仍无法使用

**可能原因**：
1. `AI_API_KEY` 未配置或错误
2. AI 服务提供商配置错误
3. 网络连接问题

**解决**：
1. 检查 `AI_API_KEY` 是否正确
2. 检查 `AI_PROVIDER` 配置（如果需要）
3. 查看运行日志中的具体错误

---

## 🔍 需要的信息

为了帮您快速定位问题，请告诉我：

1. **服务状态**：
   - 实例数量是多少？
   - 服务状态是什么？

2. **运行日志**：
   - 最新的日志信息是什么？
   - 有没有错误信息？

3. **环境变量**：
   - 哪些环境变量已配置？
   - 哪些还缺失？

4. **数据库**：
   - 数据库是否已创建？
   - `DATABASE_URL` 是否已配置？

**告诉我这些信息，我可以帮您快速定位和解决问题！**
