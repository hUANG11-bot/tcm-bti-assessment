# 修复 API 地址配置

## ✅ 已修复

**已修复开发环境的 API 地址配置**：
- 开发环境：使用 `http://localhost:3000`（本地后端服务器）
- 生产环境：使用 `https://er1.store`（生产服务器）

## 🔍 问题原因

1. **小程序配置的 API 地址是 `https://er1.store`**，但后端运行在 `localhost:3000`
2. **代码中硬编码了 `https://er1.store`**，没有使用配置的 `TARO_APP_API_URL`

## 🚀 立即操作

### 步骤1：重新编译小程序

**在运行 `pnpm dev:weapp` 的 PowerShell 窗口中**：

如果编译正在运行，它会自动检测文件变化并重新编译。

如果没有自动重新编译，按 `Ctrl+C` 停止，然后重新运行：

```powershell
pnpm dev:weapp
```

### 步骤2：在微信开发者工具中关闭域名校验

**如果还没有关闭**：

1. 在微信开发者工具中，点击右上角的"详情"按钮
2. 切换到"本地设置"标签
3. ✅ **勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**
4. 关闭设置窗口

### 步骤3：重新编译小程序

**在微信开发者工具中**：
1. 点击"编译"按钮
2. 或者点击"编译"旁边的下拉箭头，选择"清除缓存" → "清除所有缓存"，然后重新编译

---

## 📋 已修改的文件

### 1. `config/index.js`
- 开发环境默认使用 `http://localhost:3000`
- 生产环境使用 `https://er1.store`

### 2. `src/lib/trpc.ts`
- 使用 `TARO_APP_API_URL` 常量（由 defineConstants 注入）
- 如果没有配置，默认使用 `http://localhost:3000`

---

## ⚠️ 重要提示

### 需要同时运行两个进程

1. **后端服务器**：`pnpm dev`（运行在 `localhost:3000`）
2. **小程序编译**：`pnpm dev:weapp`（会自动重新编译）

### 开发环境配置

- **API 地址**：`http://localhost:3000`
- **需要关闭域名校验**：在微信开发者工具中关闭域名校验

### 生产环境配置

如果需要部署到生产环境：
- 设置环境变量：`TARO_APP_API_URL=https://er1.store`
- 或者在微信公众平台配置 `https://er1.store` 为合法域名

---

## 🚀 立即操作

**小程序编译应该会自动重新编译**（因为开启了 watch 模式）。

**如果没有自动重新编译**：

1. 在运行 `pnpm dev:weapp` 的窗口中按 `Ctrl+C` 停止
2. 重新运行：`pnpm dev:weapp`
3. 等待编译完成
4. 在微信开发者工具中关闭域名校验
5. 重新编译小程序

---

**完成以上步骤后，小程序应该可以正常连接到后端服务器了！**
