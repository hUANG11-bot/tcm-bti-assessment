# 修复"无法连接到服务器"错误

## 🔍 问题诊断

如果小程序显示错误："无法连接到服务器 http://localhost:3000"

这说明前端无法连接到后端服务，需要检查以下几点：

## ✅ 解决步骤

### 步骤1：启动后端服务

**在终端中运行：**

```bash
pnpm dev
```

**成功启动后会看到：**
```
Server running on http://localhost:3000/
```

**如果端口被占用，会显示：**
```
Port 3000 is busy, using port 3001 instead
Server running on http://localhost:3001/
```

**注意：** 如果端口不是3000，需要更新配置（见步骤3）

### 步骤2：关闭微信开发者工具的域名校验

**在微信开发者工具中：**

1. 点击右上角的 **"详情"** 按钮
2. 切换到 **"本地设置"** 标签
3. 勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**
4. 关闭设置窗口

**这一步很重要！** 开发环境使用 `localhost`，不在微信的合法域名列表中，必须关闭校验才能访问。

### 步骤3：检查端口配置

**如果后端服务运行在非3000端口（如3001），需要更新配置：**

1. **检查后端实际运行的端口**
   - 查看 `pnpm dev` 启动后的输出
   - 确认显示的端口号（如 `http://localhost:3001/`）

2. **更新 `.env` 文件**
   ```env
   TARO_APP_API_URL=http://localhost:3001
   ```
   （将3001替换为实际端口）

3. **重新编译小程序**
   ```bash
   # 停止当前编译（Ctrl+C）
   # 重新启动编译
   pnpm dev:weapp
   ```

### 步骤4：验证后端服务可访问

**在浏览器中打开：**
```
http://localhost:3000
```
（或你配置的实际端口）

**应该能看到服务器响应**（可能是空白页面或错误页面，但不会显示"无法连接"）

### 步骤5：清除小程序缓存

**在微信开发者工具中：**

1. 点击 **"编译"** 按钮旁边的下拉箭头
2. 选择 **"清除缓存"**
3. 重新编译小程序

## 🧪 测试连接

完成以上步骤后：

1. **在小程序中进入AI中医咨询页面**
2. **发送一条测试消息**
3. **查看是否能正常连接**

如果仍然无法连接，请查看：

- **后端控制台**：是否有错误日志
- **小程序控制台**：打开调试器 → Console，查看详细错误信息

## 📋 完整检查清单

- [ ] 后端服务正在运行（`pnpm dev`）
- [ ] 后端服务运行在正确的端口（通常是3000）
- [ ] `.env` 中的 `TARO_APP_API_URL` 与后端端口一致
- [ ] 微信开发者工具中关闭了域名校验
- [ ] 小程序已重新编译
- [ ] 浏览器可以访问后端服务（`http://localhost:3000`）

## 🔧 常见问题

### 问题1：端口被占用

**错误信息：**
```
Port 3000 is busy, using port 3001 instead
```

**解决：**
- 更新 `.env` 中的 `TARO_APP_API_URL=http://localhost:3001`
- 重新编译小程序

### 问题2：后端服务启动失败

**检查：**
- `.env` 文件是否存在
- 必需的环境变量是否配置
- 运行 `pnpm check-env` 检查配置

### 问题3：关闭域名校验后仍然无法连接

**检查：**
- 后端服务是否真的在运行
- 端口号是否匹配
- 防火墙是否阻止了连接
- 尝试在浏览器中直接访问后端地址

## 💡 提示

- **开发环境**：必须关闭域名校验才能使用 `localhost`
- **生产环境**：必须在微信公众平台配置合法域名，使用 HTTPS
- **端口变更**：如果后端端口改变，记得更新 `.env` 并重新编译小程序
