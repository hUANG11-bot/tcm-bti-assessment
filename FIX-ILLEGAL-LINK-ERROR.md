# 修复"不合法的链接"错误（error code: -9527002）

## 🚨 错误说明

错误信息：`不合法的链接, error code: -9527002`

这个错误表示小程序尝试访问的API地址不符合微信的要求，通常会导致：
- ❌ 微信无法一键登录
- ❌ AI中医无法使用
- ❌ 所有需要调用后端API的功能都无法使用

## 🔍 错误原因

1. **服务器域名未配置**（最常见）
2. **API地址使用了HTTP而不是HTTPS**
3. **API地址使用了localhost或IP地址**
4. **API地址格式不正确**（包含端口号等）
5. **域名未通过ICP备案**（国内服务器）

## ✅ 解决步骤

### 步骤1：检查当前API地址配置

**查看小程序编译时使用的API地址：**

1. **检查编译配置**：
   - 查看 `config/index.js` 中的 `TARO_APP_API_URL`
   - 或查看编译时使用的环境变量

2. **检查编译后的代码**：
   - 打开 `dist` 目录
   - 搜索 `localhost` 或 `http://`
   - 确认是否使用了错误的地址

### 步骤2：配置服务器域名（必须）

**在微信公众平台配置：**

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **进入开发设置**
   - 点击：**开发** → **开发管理** → **开发设置**
   - 找到 **"服务器域名"** 部分

3. **配置request合法域名**
   - 点击 **"修改"** 按钮
   - 在 **"request合法域名"** 中添加您的后端API地址
   - **重要**：必须使用HTTPS，不能使用HTTP

**域名要求：**
- ✅ 必须使用 **HTTPS**（不能使用 HTTP）
- ✅ 必须通过 **ICP 备案**（国内服务器）
- ✅ 不能使用 **IP 地址**（如：`192.168.1.1`）
- ✅ 不能使用 **localhost**（如：`http://localhost:3000`）
- ✅ 不能使用 **端口号**（默认443，不能写`:3000`）
- ✅ 格式：`https://api.yourdomain.com` 或 `https://xxx.cloudbaseapp.com`

**示例（普通服务器）：**
```
request合法域名：
https://api.yourdomain.com
```

**示例（云托管）：**
```
request合法域名：
https://tcm-api-cloud1-0g2dym0r58f17842.cloudbaseapp.com
```

### 步骤3：更新API地址配置

#### 如果您使用云托管

1. **获取云托管地址**
   - 登录微信公众平台
   - 进入：**云服务** → **云开发** → **云托管**
   - 找到您的服务，复制访问地址
   - 格式：`https://服务名-环境ID.cloudbaseapp.com`

2. **重新编译小程序**
   ```bash
   # 使用云托管地址编译
   set TARO_APP_API_URL=https://tcm-api-cloud1-0g2dym0r58f17842.cloudbaseapp.com && pnpm build:weapp
   ```
   （替换为您的实际地址）

3. **配置服务器域名**
   - 在微信公众平台的"服务器域名"中添加云托管地址

#### 如果您使用普通服务器

1. **确认服务器地址**
   - 确保服务器使用HTTPS
   - 确保域名已通过ICP备案
   - 格式：`https://api.yourdomain.com`

2. **重新编译小程序**
   ```bash
   # 使用生产环境地址编译
   set TARO_APP_API_URL=https://api.yourdomain.com && pnpm build:weapp
   ```

3. **配置服务器域名**
   - 在微信公众平台的"服务器域名"中添加您的API地址

### 步骤4：清除缓存并重新编译

1. **删除旧的编译文件**
   ```bash
   # 删除 dist 目录
   rmdir /s /q dist
   ```

2. **重新编译**
   ```bash
   # 使用正确的API地址重新编译
   set TARO_APP_API_URL=https://你的API地址 && pnpm build:weapp
   ```

3. **在微信开发者工具中**
   - 点击"编译"旁边的下拉箭头
   - 选择"清除缓存"
   - 重新编译小程序

### 步骤5：验证配置

1. **检查编译后的代码**
   - 打开 `dist` 目录
   - 搜索API地址，确认使用的是HTTPS地址
   - 确认不是 `localhost` 或 `http://`

2. **测试API地址**
   - 在浏览器中访问API地址
   - 确认可以正常访问（可能显示错误页面，但不应该显示"无法连接"）

3. **在小程序中测试**
   - 重新加载小程序
   - 尝试使用需要调用API的功能
   - 查看是否还有"不合法的链接"错误

## 🔧 常见问题

### Q1: 如何确认API地址是否正确？

**A**: 检查以下几点：
1. ✅ 使用HTTPS（不是HTTP）
2. ✅ 不是localhost或IP地址
3. ✅ 不包含端口号（默认443）
4. ✅ 已在微信公众平台配置为合法域名

### Q2: 云托管地址在哪里获取？

**A**: 
1. 登录微信公众平台
2. 进入：**云服务** → **云开发** → **云托管**
3. 找到您的服务，查看"访问地址"或"域名"

### Q3: 配置服务器域名后多久生效？

**A**: 
- 通常立即生效
- 如果不行，清除小程序缓存并重新编译

### Q4: 开发环境可以使用localhost吗？

**A**: 
- 开发环境可以在微信开发者工具中关闭域名校验
- 但正式发布必须配置合法域名
- 生产环境不能使用localhost

### Q5: 如何检查域名是否已配置？

**A**:
1. 登录微信公众平台
2. 进入：**开发** → **开发管理** → **开发设置**
3. 查看"服务器域名"中的"request合法域名"列表
4. 确认您的API地址在列表中

## 📋 完整检查清单

- [ ] 已获取正确的API地址（HTTPS格式）
- [ ] 已在微信公众平台配置服务器域名
- [ ] 服务器域名使用HTTPS
- [ ] 已使用正确的API地址重新编译小程序
- [ ] 已清除小程序缓存
- [ ] 已重新加载小程序
- [ ] 错误已消失，功能正常

## 💡 重要提示

1. **生产环境必须使用HTTPS**：微信小程序不允许使用HTTP
2. **必须配置服务器域名**：未配置的域名会报"不合法的链接"错误
3. **不能使用localhost**：生产环境必须使用真实域名
4. **重新编译很重要**：修改配置后必须重新编译小程序
5. **清除缓存**：配置更改后清除缓存确保生效

## 🚀 快速修复

如果看到"不合法的链接"错误，立即执行：

1. **配置服务器域名**（最重要）
   ```
   微信公众平台 → 开发 → 开发管理 → 开发设置 → 服务器域名
   添加：https://你的API地址
   ```

2. **重新编译小程序**
   ```bash
   set TARO_APP_API_URL=https://你的API地址 && pnpm build:weapp
   ```

3. **清除缓存并重新加载**
   - 在微信开发者工具中清除缓存
   - 重新编译并加载小程序

## 📞 获取帮助

如果按照以上步骤仍然无法解决：

1. **确认API地址格式**：
   - 必须是 `https://` 开头
   - 不能包含端口号
   - 不能是localhost或IP

2. **检查服务器域名配置**：
   - 登录微信公众平台确认域名已添加
   - 确认域名格式正确

3. **查看详细错误**：
   - 在微信开发者工具中打开"调试器"
   - 查看Console中的详细错误信息

4. **检查文档**：
   - `CLOUD-DEVELOPMENT-SETUP.md` - 云开发配置指南
   - `PRODUCTION-ISSUES-FIX.md` - 生产环境问题修复
