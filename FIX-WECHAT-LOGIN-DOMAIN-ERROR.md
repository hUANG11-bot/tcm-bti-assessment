# 修复微信登录域名校验错误

## ❌ 当前错误

```
request 合法域名校验出错
http://localhost:3000 不在以下 request 合法域名列表中
微信登录失败: request:fail url not in domain list
```

## 🎯 问题原因

微信小程序不允许访问未配置的域名。`http://localhost:3000` 不在微信的合法域名列表中。

---

## 🔧 解决方案

### 方案1：开发环境 - 关闭域名校验（推荐，快速解决）

**适用于：** 本地开发测试

#### 步骤1：在微信开发者工具中关闭域名校验

1. **打开微信开发者工具**
2. **点击右上角"详情"按钮**
3. **切换到"本地设置"标签**
4. **勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**
5. **关闭设置窗口**

#### 步骤2：清除缓存并重新编译

1. **点击"编译"按钮旁边的下拉箭头**
2. **选择"清除缓存"**
3. **选择"清除所有缓存"**
4. **点击"编译"按钮重新编译**

#### 步骤3：测试登录

1. 打开"我的"页面
2. 点击"微信一键登录"
3. 应该可以正常登录了

---

### 方案2：生产环境 - 使用实际域名（推荐，生产环境必须）

**适用于：** 生产环境或需要正式发布

#### 步骤1：修改API地址配置

**方法A：修改 `.env` 文件（推荐）**

```env
# 将 localhost 改为实际域名
TARO_APP_API_URL=https://er1.store
```

**方法B：修改 `config/index.js`**

```javascript
defineConstants: {
  TARO_APP_API_URL: JSON.stringify(
    process.env.TARO_APP_API_URL || 'https://er1.store'  // 改为实际域名
  )
}
```

#### 步骤2：在微信公众平台配置合法域名

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **进入开发设置**
   - 开发 → 开发管理 → 开发设置
   - 找到"服务器域名"部分

3. **添加request合法域名**
   - 在"request合法域名"中添加：
     - `https://er1.store`
     - 或您的实际API地址
   - 点击"保存"

4. **等待生效**
   - 域名配置可能需要几分钟生效

#### 步骤3：重新编译小程序

```bash
# 停止当前编译（Ctrl+C）
# 重新编译
pnpm dev:weapp
```

#### 步骤4：清除缓存

**在微信开发者工具中：**
- 编译 → 清除缓存 → 清除所有缓存

#### 步骤5：测试登录

1. 打开"我的"页面
2. 点击"微信一键登录"
3. 应该可以正常登录了

---

## 📝 完整操作步骤（推荐方案1 - 开发环境）

### 1. 关闭域名校验

**在微信开发者工具中：**
1. 点击右上角"详情"
2. 切换到"本地设置"
3. ✅ 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
4. 关闭设置窗口

### 2. 清除缓存

1. 点击"编译"旁边的下拉箭头
2. 选择"清除缓存"
3. 选择"清除所有缓存"

### 3. 重新编译

1. 点击"编译"按钮
2. 等待编译完成

### 4. 测试登录

1. 打开"我的"页面
2. 点击"微信一键登录"
3. 查看是否成功

---

## ⚠️ 重要说明

### 开发环境 vs 生产环境

**开发环境：**
- ✅ 可以使用"关闭域名校验"（方案1）
- ✅ 可以使用 `http://localhost:3000`
- ⚠️ 仅用于开发测试，不能用于正式发布

**生产环境：**
- ❌ 不能关闭域名校验
- ❌ 不能使用 `http://localhost:3000`
- ✅ 必须使用 HTTPS 域名（如 `https://er1.store`）
- ✅ 必须在微信公众平台配置合法域名

### 域名要求

**生产环境域名必须：**
- ✅ 使用 HTTPS（不能是 HTTP）
- ✅ 已备案（国内服务器）
- ✅ 在微信公众平台配置为合法域名
- ✅ 格式正确：`https://域名`（不包含端口号）

---

## 🔍 验证配置是否生效

### 方法1：查看控制台日志

**在微信开发者工具的 Console 中：**

**如果使用 localhost（开发环境）：**
```
[tRPC] API Base URL: http://localhost:3000
```

**如果使用生产域名：**
```
[tRPC] API Base URL: https://er1.store
```

### 方法2：测试网络请求

**点击"微信一键登录"后，查看控制台：**

**成功时：**
- 没有域名校验错误
- 看到登录请求发送成功

**失败时：**
- 仍然看到 `url not in domain list` 错误
- 说明域名校验未关闭或域名未配置

---

## ✅ 快速检查清单

完成以下步骤：

- [ ] 已关闭域名校验（开发环境）或已配置合法域名（生产环境）
- [ ] 已清除微信开发者工具缓存
- [ ] 已重新编译小程序
- [ ] 控制台不再显示域名校验错误
- [ ] 微信登录功能正常工作

---

## 💡 推荐方案

**如果您正在开发测试：**
- ✅ 使用**方案1**（关闭域名校验）
- 快速、简单、无需配置

**如果您要发布到生产环境：**
- ✅ 使用**方案2**（配置实际域名）
- 必须配置，否则用户无法使用

---

## 🎉 完成

完成以上步骤后，微信一键登录功能应该可以正常使用了！

如果仍有问题，请查看：
- [微信登录修复指南](./FIX-WECHAT-LOGIN.md)
- [微信登录错误排查](./WECHAT-LOGIN-TROUBLESHOOTING.md)
