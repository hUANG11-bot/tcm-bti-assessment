# 微信小程序发布指南

本指南将帮助您完成微信小程序的发布流程，从开发环境到正式上线。

## 📋 发布前准备

### 1. 检查小程序配置

#### 1.1 检查 AppID 配置

确保 `src/app.config.ts` 中的配置正确：

```typescript
// 确认 AppID 正确
export default {
  // ... 其他配置
}
```

在微信开发者工具中：
- 打开项目设置
- 确认 AppID 与微信公众平台中的一致

#### 1.2 配置服务器域名

**重要**：必须在微信公众平台配置合法域名！

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入：**开发** → **开发管理** → **开发设置**
3. 在 **服务器域名** 中配置：

   - **request合法域名**：添加您的后端 API 域名
     ```
     例如：https://api.yourdomain.com
     ```
   - **uploadFile合法域名**：如果需要上传文件
   - **downloadFile合法域名**：如果需要下载文件

4. **注意事项**：
   - 域名必须使用 HTTPS
   - 域名必须通过 ICP 备案（国内服务器）
   - 域名不能使用 IP 地址
   - 域名不能使用端口号（默认 443）

### 2. 环境变量配置

#### 2.1 后端环境变量

在服务器上配置 `.env` 文件：

```env
# 微信小程序配置
WX_APPID=wx04a7af67c8f47620
WX_SECRET=你的AppSecret

# 数据库配置
DATABASE_URL=mysql://user:password@host:port/database

# API 地址（用于小程序）
TARO_APP_API_URL=https://api.yourdomain.com

# 其他配置
NODE_ENV=production
JWT_SECRET=你的JWT密钥
```

#### 2.2 前端环境变量

在编译小程序时，API 地址通过 `TARO_APP_API_URL` 环境变量设置：

```bash
# Windows (CMD)
set TARO_APP_API_URL=https://api.yourdomain.com && pnpm build:weapp

# Windows (PowerShell)
$env:TARO_APP_API_URL="https://api.yourdomain.com"; pnpm build:weapp

# Linux/Mac
TARO_APP_API_URL=https://api.yourdomain.com pnpm build:weapp
```

或者在 `config/index.js` 中直接修改默认值。

### 3. 功能测试

在发布前，确保以下功能正常：

- [ ] 用户登录功能
- [ ] 体质测评功能
- [ ] 结果展示
- [ ] 数据保存
- [ ] 页面跳转
- [ ] 分享功能
- [ ] 管理员登录（如需要）

### 4. 性能优化

#### 4.1 代码优化

```bash
# 生产环境编译（会自动压缩和优化）
set NODE_ENV=production && pnpm build:weapp
```

#### 4.2 图片优化

- 压缩图片资源
- 使用合适的图片格式（WebP、PNG、JPG）
- 控制图片大小

#### 4.3 代码体积

- 检查小程序包大小（主包不超过 2MB）
- 如果超过限制，考虑分包加载

## 🚀 发布流程

### 步骤 1：编译生产版本

```bash
# 1. 设置生产环境变量
set NODE_ENV=production
set TARO_APP_API_URL=https://api.yourdomain.com

# 2. 编译小程序
pnpm build:weapp
```

编译完成后，代码会生成在 `dist` 目录。

### 步骤 2：上传代码

1. **打开微信开发者工具**
   - 导入项目，选择 `dist` 目录
   - 确认 AppID 正确

2. **检查编译结果**
   - 在模拟器中测试功能
   - 检查控制台是否有错误

3. **上传代码**
   - 点击工具栏的 **"上传"** 按钮
   - 填写版本号和项目备注：
     ```
     版本号：1.0.0
     项目备注：首次发布
     ```
   - 点击 **"上传"**

4. **确认上传成功**
   - 上传成功后，会显示上传信息
   - 记录版本号，后续审核需要

### 步骤 3：提交审核

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **进入版本管理**
   - 进入：**版本管理** → **开发版本**
   - 找到刚才上传的版本

3. **提交审核**
   - 点击 **"提交审核"** 按钮
   - 填写审核信息：

   **基本信息**：
   - 选择类目（例如：医疗 → 健康管理）
   - 标签（可选）

   **版本描述**：
   ```
   功能描述：
   - 中医体质评估功能
   - 用户登录和测评记录
   - 个性化调理建议
   - 管理员后台管理
   
   修复问题：
   首次发布
   ```

   **测试账号**（如果需要）：
   - 提供测试账号和密码
   - 说明测试步骤

4. **确认提交**
   - 阅读并同意《微信小程序平台服务条款》
   - 点击 **"提交审核"**

### 步骤 4：等待审核

- **审核时间**：通常 1-7 个工作日
- **审核状态**：在 **版本管理** → **审核版本** 中查看
- **审核结果**：
  - ✅ **审核通过**：可以发布
  - ❌ **审核不通过**：查看拒绝原因，修改后重新提交

### 步骤 5：发布上线

1. **审核通过后**
   - 在 **版本管理** → **审核版本** 中
   - 点击 **"发布"** 按钮

2. **确认发布**
   - 确认版本信息
   - 点击 **"确认发布"**

3. **发布成功**
   - 小程序正式上线
   - 用户可以通过搜索或扫码访问

## 🔧 常见问题

### Q1: 上传代码时提示"包体积过大"

**解决方法**：
1. 检查 `dist` 目录大小
2. 优化图片资源
3. 使用分包加载
4. 移除不必要的依赖

### Q2: 审核被拒，提示"功能不完整"

**解决方法**：
1. 确保所有页面可以正常访问
2. 确保核心功能完整可用
3. 提供详细的测试账号和步骤

### Q3: 审核被拒，提示"类目不符"

**解决方法**：
1. 检查选择的类目是否正确
2. 根据小程序实际功能选择合适类目
3. 可能需要提供相关资质证明

### Q4: 生产环境 API 无法访问

**解决方法**：
1. 检查服务器域名是否配置正确
2. 检查服务器是否正常运行
3. 检查防火墙和网络配置
4. 确认域名已通过 ICP 备案

### Q5: 小程序在真机上无法登录

**解决方法**：
1. 检查 AppSecret 是否正确配置
2. 检查服务器域名是否在合法域名列表中
3. 检查后端日志，查看具体错误信息
4. 参考 `WECHAT-LOGIN-TROUBLESHOOTING.md`

## 📝 发布检查清单

发布前，请确认以下事项：

### 代码检查
- [ ] 代码已编译为生产版本
- [ ] 所有功能测试通过
- [ ] 没有控制台错误
- [ ] 包体积在限制范围内

### 配置检查
- [ ] AppID 配置正确
- [ ] 服务器域名已配置
- [ ] 环境变量已设置
- [ ] 数据库连接正常

### 功能检查
- [ ] 用户登录功能正常
- [ ] 测评功能完整
- [ ] 数据保存正常
- [ ] 页面跳转正常
- [ ] 分享功能正常

### 内容检查
- [ ] 页面文案无误
- [ ] 图片显示正常
- [ ] 没有敏感信息
- [ ] 符合微信规范

### 审核准备
- [ ] 已选择正确的类目
- [ ] 已准备版本描述
- [ ] 已准备测试账号（如需要）
- [ ] 已阅读审核规范

## 🎯 发布后维护

### 1. 监控数据

- 访问量统计
- 用户反馈
- 错误日志
- 性能监控

### 2. 版本更新

当需要更新小程序时：

1. 修改代码
2. 重新编译：`pnpm build:weapp`
3. 上传新版本
4. 提交审核
5. 发布更新

### 3. 回滚版本

如果新版本有问题：

1. 在 **版本管理** → **线上版本**
2. 点击 **"版本回退"**
3. 选择要回退的版本
4. 确认回退

## 📚 相关文档

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信小程序审核规范](https://developers.weixin.qq.com/miniprogram/product/)
- [Taro 官方文档](https://taro-docs.jd.com/docs/)

## 💡 提示

1. **首次发布**：建议先在测试环境充分测试
2. **版本号**：遵循语义化版本规范（如 1.0.0）
3. **备份**：发布前备份代码和数据库
4. **监控**：发布后密切关注用户反馈和错误日志
5. **合规**：确保小程序内容符合法律法规和微信规范

---

**祝您发布顺利！** 🎉
