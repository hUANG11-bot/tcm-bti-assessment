# AI中医功能快速修复指南

## 🚨 当前问题

根据截图显示，小程序提示："无法连接到服务器 http://localhost:3000"

这说明有两个问题需要解决：
1. **后端服务连接问题**（当前问题）
2. **AI服务余额不足**（之前发现的问题）

## ✅ 解决步骤（按顺序执行）

### 步骤1：启动后端服务 ⚠️ 必须

**打开新的终端窗口，运行：**

```bash
cd d:\tcm-bti-assessment
pnpm dev
```

**成功后会看到：**
```
Server running on http://localhost:3000/
```

**⚠️ 重要：** 这个终端窗口必须保持运行，不要关闭！

### 步骤2：关闭微信开发者工具的域名校验 ⚠️ 必须

**在微信开发者工具中：**

1. 点击右上角的 **"详情"** 按钮
2. 切换到 **"本地设置"** 标签  
3. ✅ **勾选** "不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
4. 关闭设置窗口

**这一步非常重要！** 开发环境必须关闭域名校验才能访问 `localhost`。

### 步骤3：重新编译小程序

**在另一个终端窗口中：**

```bash
cd d:\tcm-bti-assessment
pnpm dev:weapp
```

等待编译完成。

### 步骤4：清除小程序缓存并重新加载

**在微信开发者工具中：**

1. 点击 **"编译"** 按钮旁边的下拉箭头
2. 选择 **"清除缓存"**
3. 点击 **"编译"** 重新编译

### 步骤5：测试连接

1. 在小程序中进入AI中医咨询页面
2. 发送一条测试消息
3. 查看是否能正常连接

**如果仍然显示连接错误，检查：**
- 后端服务是否真的在运行（查看终端窗口）
- 浏览器能否访问 `http://localhost:3000`（应该能看到响应）

### 步骤6：解决AI服务余额问题

**连接成功后，如果AI回复失败，需要解决余额问题：**

#### 选项A：充值DeepSeek账户（推荐）

1. 访问：https://platform.deepseek.com
2. 登录账户
3. 充值余额
4. 重新测试

#### 选项B：配置备用服务（Forge API）

1. 访问：https://forge.manus.im
2. 注册/登录并获取API密钥
3. 在 `.env` 文件中添加：
   ```env
   BUILT_IN_FORGE_API_URL=https://forge.manus.im
   BUILT_IN_FORGE_API_KEY=你的Forge密钥
   ```
4. 重启后端服务（在运行 `pnpm dev` 的终端按 Ctrl+C，然后重新运行）

## 📋 完整检查清单

### 后端服务
- [ ] 运行 `pnpm dev` 启动后端服务
- [ ] 看到 "Server running on http://localhost:3000/"
- [ ] 浏览器可以访问 `http://localhost:3000`

### 小程序配置
- [ ] 微信开发者工具中关闭了域名校验
- [ ] 运行 `pnpm dev:weapp` 编译小程序
- [ ] 清除了小程序缓存
- [ ] 重新编译并加载小程序

### AI服务
- [ ] DeepSeek账户已充值（或配置了备用服务）
- [ ] 运行 `pnpm test-ai-chat` 测试通过

## 🔧 常见问题

### Q1: 后端服务启动失败

**检查：**
```bash
pnpm check-env
```

确认所有必需配置都已设置。

### Q2: 端口被占用

如果看到：
```
Port 3000 is busy, using port 3001 instead
```

**解决：**
1. 更新 `.env` 文件：
   ```env
   TARO_APP_API_URL=http://localhost:3001
   ```
2. 重新编译小程序

### Q3: 关闭域名校验后仍然无法连接

**检查：**
1. 后端服务是否真的在运行
2. 在浏览器中访问 `http://localhost:3000` 是否能打开
3. 防火墙是否阻止了连接

## 💡 提示

- **开发环境**：必须同时运行后端服务（`pnpm dev`）和小程序编译（`pnpm dev:weapp`）
- **两个终端**：建议打开两个终端窗口，一个运行后端，一个运行小程序编译
- **域名校验**：开发环境必须关闭，生产环境必须配置合法域名

## 📞 获取帮助

如果按照以上步骤仍然无法解决：

1. **查看详细错误**：
   - 后端控制台的错误日志
   - 小程序控制台（调试器 → Console）

2. **运行诊断工具**：
   ```bash
   pnpm check-env      # 检查配置
   pnpm test-ai-chat    # 测试AI服务
   ```

3. **查看文档**：
   - `FIX-CONNECTION-ERROR.md` - 连接问题详细指南
   - `AI-BALANCE-FIX.md` - 余额问题解决方案
   - `AI-DIAGNOSIS.md` - 完整诊断指南
