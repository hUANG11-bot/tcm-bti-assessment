# 部署后仍无法连接 - 故障排查

## 🚨 问题现象

**错误信息**：`无法连接到服务器 请检查: 1. 后端服务是否运行`

这说明虽然已经部署，但服务可能：
1. 没有运行
2. 启动失败
3. 配置有问题

---

## 🔍 排查步骤

### 步骤1：检查服务是否运行

1. **进入微信云托管控制台**
2. **服务管理** → **服务列表**
3. **找到您的服务**
4. **查看实例数量**：
   - ✅ **正常运行**：实例数量 > 0（如：1个实例）
   - ❌ **未运行**：实例数量 = 0（自动暂停）

**如果显示"0个实例 (自动暂停)"**：
- 点击"部署发布"标签
- 点击"发布"按钮启动服务
- 等待实例启动（1-2 分钟）

---

### 步骤2：查看运行日志（最重要）

1. **点击"运行日志"标签**
2. **查看最近的日志**
3. **查找错误信息**

**常见错误**：

#### 错误1：环境变量缺失
```
Error: Missing required environment variable: WX_APPID
Error: Missing required environment variable: AI_API_KEY
```
**解决**：在"服务设置"中添加缺失的环境变量

---

#### 错误2：数据库连接失败
```
Error: connect ECONNREFUSED
Error: Access denied for user 'root'@'xxx'
Error: Unknown database 'tcm_bti_assessment'
```
**可能原因**：
- `DATABASE_URL` 格式错误
- 密码错误
- 数据库不存在
- 安全组/白名单未配置

**解决**：
1. 检查 `DATABASE_URL` 格式
2. 确认密码正确
3. 确认数据库已创建
4. 检查安全组和白名单

---

#### 错误3：服务启动失败
```
Error: Cannot find package 'xxx'
Error: listen EADDRINUSE
```
**解决**：根据具体错误信息修复

---

### 步骤3：检查所有必需的环境变量

1. **点击"服务设置"标签**
2. **找到"环境变量"部分**
3. **确认以下必需变量已配置**：

#### 必需环境变量清单

- [ ] `DATABASE_URL` - 数据库连接字符串
  - 格式：`mysql://root:密码@sh-cdb-pvaed2ys.sql.tencentcdb.com:23371/tcm_bti_assessment`
  - ⚠️ **注意**：确保密码后面没有多余的逗号或空格

- [ ] `WX_APPID` - 微信小程序 AppID
  - 在微信公众平台获取

- [ ] `WX_SECRET` - 微信小程序 AppSecret
  - 在微信公众平台获取

- [ ] `JWT_SECRET` - JWT 密钥
  - 至少 32 字符的随机字符串

- [ ] `AI_API_KEY` - AI 服务 API 密钥
  - DeepSeek 或其他 AI 服务的 API 密钥

---

### 步骤4：检查 DATABASE_URL 格式

**确认格式正确**：
```
mysql://root:密码@sh-cdb-pvaed2ys.sql.tencentcdb.com:23371/tcm_bti_assessment
```

**常见错误**：
- ❌ 密码后面有逗号或空格：`Huangte991,, @`
- ✅ 正确格式：`Huangte991@`

**如果密码包含特殊字符**，需要进行 URL 编码：
- `,` → `%2C`
- `@` → `%40`
- `:` → `%3A`

---

### 步骤5：检查数据库

1. **确认数据库已创建**：
   - 在腾讯云控制台
   - 数据库实例详情页
   - "数据库管理"标签
   - 确认数据库 `tcm_bti_assessment` 已创建

2. **检查安全组和白名单**：
   - 在数据库实例详情页
   - "安全组"或"访问控制"标签
   - 确保允许微信云托管访问
   - 或暂时允许所有 IP（仅用于测试）

---

## 🔧 快速修复步骤

### 如果服务未运行

1. **启动服务**：
   - 进入"部署发布"页面
   - 点击"发布"按钮
   - 等待实例启动

2. **检查运行日志**：
   - 查看是否有错误信息
   - 根据错误信息修复

---

### 如果环境变量缺失

1. **进入"服务设置"**
2. **添加缺失的环境变量**：
   - `WX_APPID`
   - `WX_SECRET`
   - `JWT_SECRET`
   - `AI_API_KEY`
   - `DATABASE_URL`（如果还没配置）

3. **保存配置**
4. **重新部署服务**

---

### 如果 DATABASE_URL 格式错误

1. **检查 `DATABASE_URL`**：
   - 确保格式正确
   - 删除密码后面的逗号或空格
   - 确认密码正确

2. **更新环境变量**：
   - 在"服务设置"中
   - 编辑 `DATABASE_URL`
   - 修正格式
   - 保存配置

3. **重新部署服务**

---

### 如果数据库连接失败

1. **检查数据库是否创建**：
   - 在"数据库管理"中确认数据库存在

2. **检查连接字符串**：
   - 确认格式正确
   - 确认密码正确
   - 确认端口是 `23371`

3. **检查安全组和白名单**：
   - 确保允许微信云托管访问

---

## 📋 完整检查清单

在排查问题时，请确认：

### 服务状态
- [ ] 服务实例数量 > 0（服务正在运行）
- [ ] 服务状态显示"正常"

### 环境变量
- [ ] `DATABASE_URL` 已配置（格式正确，没有多余的逗号或空格）
- [ ] `WX_APPID` 已配置
- [ ] `WX_SECRET` 已配置
- [ ] `JWT_SECRET` 已配置
- [ ] `AI_API_KEY` 已配置

### 数据库
- [ ] 数据库实例已创建并运行
- [ ] 数据库已创建（如：`tcm_bti_assessment`）
- [ ] 安全组规则允许连接
- [ ] 白名单配置正确

### 运行日志
- [ ] 没有错误信息
- [ ] 服务正常启动（看到 "Server started on port 3000" 等）

---

## 🎯 现在请

1. **检查服务状态**：
   - 实例数量是多少？
   - 服务是否在运行？

2. **查看运行日志**：
   - 点击"运行日志"标签
   - 查看最新的日志
   - **告诉我具体的错误信息**

3. **检查环境变量**：
   - 进入"服务设置"
   - 确认所有必需的环境变量已配置
   - 检查 `DATABASE_URL` 格式是否正确

4. **告诉我结果**：
   - 服务状态
   - 运行日志中的错误信息
   - 哪些环境变量已配置

---

## 💡 常见问题

### Q1：服务显示"0个实例 (自动暂停)"

**原因**：服务未启动

**解决**：
1. 点击"发布"按钮启动服务
2. 检查最小实例数是否设置为至少 1

---

### Q2：运行日志显示环境变量缺失

**原因**：必需的环境变量未配置

**解决**：
1. 进入"服务设置"
2. 添加缺失的环境变量
3. 保存并重新部署

---

### Q3：运行日志显示数据库连接错误

**可能原因**：
1. `DATABASE_URL` 格式错误（密码后面有逗号或空格）
2. 密码错误
3. 数据库不存在
4. 安全组/白名单未配置

**解决**：
1. 检查 `DATABASE_URL` 格式
2. 确认密码正确
3. 确认数据库已创建
4. 检查安全组和白名单

---

### Q4：服务启动但 AI 仍无法使用

**可能原因**：
1. `AI_API_KEY` 未配置或错误
2. `WX_APPID` 或 `WX_SECRET` 未配置
3. 其他配置问题

**解决**：
1. 检查所有必需的环境变量
2. 查看运行日志中的具体错误
3. 确认配置正确

---

## 🔍 需要的信息

为了帮您快速定位问题，请告诉我：

1. **服务状态**：
   - 实例数量是多少？
   - 服务状态是什么？

2. **运行日志**：
   - 最新的日志信息是什么？
   - **有没有错误信息？**（最重要）
   - 如果有错误，完整的错误信息是什么？

3. **环境变量**：
   - 哪些环境变量已配置？
   - `DATABASE_URL` 的格式是什么？（可以隐藏密码，只显示格式）

4. **数据库**：
   - 数据库是否已创建？
   - 安全组和白名单是否配置？

**特别是运行日志中的错误信息，这是最关键的！**

---

## 🎯 立即操作

1. **查看运行日志**：
   - 点击"运行日志"标签
   - 复制最新的错误信息
   - 告诉我

2. **检查服务状态**：
   - 实例数量是多少？
   - 服务是否在运行？

3. **检查环境变量**：
   - 所有必需的环境变量是否都已配置？

**告诉我运行日志中的错误信息，我可以帮您快速定位和解决问题！**
