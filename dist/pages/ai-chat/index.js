/*! For license information please see index.js.LICENSE.txt */
"use strict";(wx["webpackJsonp"]=wx["webpackJsonp"]||[]).push([[620],{6276:function(e,n,t){var r=t(3897),a=t(758),o=t(5490),s=t(1093),i=t.n(s),c=t(7011),u=t(7771),l=t(6070);function f(){var e,n,t="function"==typeof Symbol?Symbol:{},r=t.iterator||"@@iterator",a=t.toStringTag||"@@toStringTag";function o(t,r,a,o){var c=r&&r.prototype instanceof i?r:i,u=Object.create(c.prototype);return d(u,"_invoke",function(t,r,a){var o,i,c,u=0,l=a||[],f=!1,d={p:0,n:0,v:e,a:m,f:m.bind(e,4),d:function(n,t){return o=n,i=0,c=e,d.n=t,s}};function m(t,r){for(i=t,c=r,n=0;!f&&u&&!a&&n<l.length;n++){var a,o=l[n],m=d.p,p=o[2];t>3?(a=p===r)&&(c=o[(i=o[4])?5:(i=3,3)],o[4]=o[5]=e):o[0]<=m&&((a=t<2&&m<o[1])?(i=0,d.v=r,d.n=o[1]):m<p&&(a=t<3||o[0]>r||r>p)&&(o[4]=t,o[5]=r,d.n=p,i=0))}if(a||t>1)return s;throw f=!0,r}return function(a,l,p){if(u>1)throw TypeError("Generator is already running");for(f&&1===l&&m(l,p),i=l,c=p;(n=i<2?e:c)||!f;){o||(i?i<3?(i>1&&(d.n=-1),m(i,c)):d.n=c:d.v=c);try{if(u=2,o){if(i||(a="next"),n=o[a]){if(!(n=n.call(o,c)))throw TypeError("iterator result is not an object");if(!n.done)return n;c=n.value,i<2&&(i=0)}else 1===i&&(n=o["return"])&&n.call(o),i<2&&(c=TypeError("The iterator does not provide a '"+a+"' method"),i=1);o=e}else if((n=(f=d.n<0)?c:t.call(r,d))!==s)break}catch(n){o=e,i=1,c=n}finally{u=1}}return{value:n,done:f}}}(t,a,o),!0),u}var s={};function i(){}function c(){}function u(){}n=Object.getPrototypeOf;var l=[][r]?n(n([][r]())):(d(n={},r,function(){return this}),n),m=u.prototype=i.prototype=Object.create(l);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,d(e,a,"GeneratorFunction")),e.prototype=Object.create(m),e}return c.prototype=u,d(m,"constructor",u),d(u,"constructor",c),c.displayName="GeneratorFunction",d(u,a,"GeneratorFunction"),d(m),d(m,a,"Generator"),d(m,r,function(){return this}),d(m,"toString",function(){return"[object Generator]"}),(f=function(){return{w:o,m:p}})()}function d(e,n,t,r){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}d=function(e,n,t,r){function o(n,t){d(e,n,function(e){return this._invoke(n,t,e)})}n?a?a(e,n,{value:t,enumerable:!r,configurable:!r,writable:!r}):e[n]=t:(o("next",0),o("throw",1),o("return",2))},d(e,n,t,r)}function m(e){return y(e)||h(e)||x(e)||p()}function p(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function h(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function y(e){if(Array.isArray(e))return S(e)}function v(e,n,t,r,a,o,s){try{var i=e[o](s),c=i.value}catch(e){return void t(e)}i.done?n(c):Promise.resolve(c).then(r,a)}function g(e){return function(){var n=this,t=arguments;return new Promise(function(r,a){var o=e.apply(n,t);function s(e){v(o,r,a,s,i,"next",e)}function i(e){v(o,r,a,s,i,"throw",e)}s(void 0)})}}function b(e,n){return w(e)||N(e,n)||x(e,n)||j()}function j(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function x(e,n){if(e){if("string"==typeof e)return S(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?S(e,n):void 0}}function S(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=Array(n);t<n;t++)r[t]=e[t];return r}function N(e,n){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var r,a,o,s,i=[],c=!0,u=!1;try{if(o=(t=t.call(e)).next,0===n){if(Object(t)!==t)return;c=!1}else for(;!(c=(r=o.call(t)).done)&&(i.push(r.value),i.length!==n);c=!0);}catch(e){u=!0,a=e}finally{try{if(!c&&null!=t["return"]&&(s=t["return"](),Object(s)!==s))return}finally{if(u)throw a}}return i}}function w(e){if(Array.isArray(e))return e}function A(){var e=(0,u.U)(),n=e.result,t=(0,a.useState)([]),r=b(t,2),s=r[0],d=r[1],p=(0,a.useState)(""),h=b(p,2),y=h[0],v=h[1],j=(0,a.useState)(!1),x=b(j,2),S=x[0],N=x[1],w=(0,a.useRef)(null),A=c.id.ai.chat.useMutation(),T=(0,a.useState)(""),I=b(T,2),E=I[0],O=I[1],M=(0,a.useState)(null),z=b(M,2),H=z[0],D=z[1],R=(0,a.useState)(null),W=b(R,2),X=W[0],Y=W[1],G=(0,a.useState)(null),J=b(G,2),K=J[0],L=J[1],Q=(0,a.useState)(null),P=b(Q,2),V=P[0],B=P[1],C=(0,a.useState)([]),F=b(C,2),U=F[0],Z=F[1],BH=(0,a.useState)([]),BI=b(BH,2),BJ=BI[0],BK=BI[1],BL=(0,a.useState)(0),BM=b(BL,2),BN=BM[0],BO=BM[1];var _=(function(){try{var e=i().getStorageSync("manus-runtime-user-info");return e&&"string"==typeof e?JSON.parse(e):e}catch(e){return null}}()),$=!(!_||!_.openId),__=null;try{if(c.id&&c.id.assessment&&c.id.assessment.myAssessments){__=c.id.assessment.myAssessments.useQuery(void 0,{"enabled":$,"retry":!1})}else{__={data:null,isLoading:!1,error:null}}}catch(e){console.error("[AI Chat] useQuery初始化失败:",e);__=__||{data:null,isLoading:!1,error:null}}(0,a.useEffect)(function(){var e=i().getCurrentPages(),t=e[e.length-1],r=t.options||{};r.bodyType?O(decodeURIComponent(r.bodyType)):null!==n&&void 0!==n&&n.mainType&&O(n.mainType);r.age&&D(parseInt(r.age,10));r.gender&&W[1](decodeURIComponent(r.gender));r.secondaryType&&L(decodeURIComponent(r.secondaryType));if(!r.bodyType){try{var u=i().getStorageSync("ai_chat_bodyType");if(u)O(u),i().removeStorageSync("ai_chat_bodyType")}catch(e){console.error("Failed to load bodyType from storage:",e)}}if(!r.age){try{var M=i().getStorageSync("ai_chat_age");if(M)D(parseInt(M,10)),i().removeStorageSync("ai_chat_age")}catch(e){console.error("Failed to load age from storage:",e)}}if(!r.gender){try{var z=i().getStorageSync("ai_chat_gender");if(z)W[1](z),i().removeStorageSync("ai_chat_gender")}catch(e){console.error("Failed to load gender from storage:",e)}}if(!r.secondaryType){try{var H=i().getStorageSync("ai_chat_secondaryType");if(H)L(H),i().removeStorageSync("ai_chat_secondaryType")}catch(e){console.error("Failed to load secondaryType from storage:",e)}}try{var u=i().getStorageSync("ai_chat_fullReport");if(u){var M="string"==typeof u?JSON.parse(u):u;B(M),i().removeStorageSync("ai_chat_fullReport")}}catch(e){console.error("Failed to load fullReport:",e)}if(!r.bodyType&&!n&&__){try{if(__.data&&__.data.length>0){var l=__.data[0];console.log("[AI Chat] 从myAssessments获取到数据:",l.primaryType,l.age,l.gender);l.primaryType&&O(l.primaryType);l.secondaryType&&L(l.secondaryType);l.age&&D(l.age);l.gender&&W[1](l.gender);l.fullReport&&B(l.fullReport)}else if(__.isLoading){console.log("[AI Chat] 正在加载测评数据...")}else if(__.error){console.error("[AI Chat] 加载测评数据失败:",__.error)}else{console.log("[AI Chat] myAssessments查询结果 - data:",__.data,"isLoading:",__.isLoading,"error:",__.error)}}catch(e){console.error("Failed to process assessments data:",e)}}},[n,__&&__.data?__.data.length:0,__&&__.data&&__.data[0]?__.data[0].id:null]);var handleAssessmentChange=function(e){var t=parseInt(e.detail.value);BO(t);if(__&&__.data&&__.data.length>t){var r=__.data[t];r.primaryType&&O(r.primaryType);r.secondaryType&&L(r.secondaryType);r.age&&D(r.age);r.gender&&W[1](r.gender);r.fullReport&&B(r.fullReport);i().setStorageSync("ai_chat_selected_assessment_id",r.id)}};(0,a.useEffect)(function(){if(0===s.length){var e=i().getStorageSync("manus-runtime-user-info"),t=null;try{if(e){var n="string"==typeof e?JSON.parse(e):e;t=n&&n.openId?n:null}}catch(e){console.error("Failed to parse user info:",e)}var r="";if(!t)r="\u60a8\u597d\uff01\u6211\u662fAI\u517b\u751f\u52a9\u624b\u3002\u76ee\u524d\u60a8\u4f7f\u7528\u7684\u662f\u901a\u7528\u517b\u751f\u52a9\u624b\u3002\u767b\u5f55\u5e76\u5b8c\u6210\u6d4b\u8bc4\u540e\u5373\u53ef\u4f53\u9a8c\u4e2a\u4eba\u8ba2\u5236\u52a9\u624b\u3002\u6211\u53ef\u4ee5\u4e3a\u60a8\u89e3\u7b54\u5173\u4e8e\u4e2d\u533b\u4f53\u8d28\u3001\u5065\u5eb7\u8c03\u7406\u7b49\u65b9\u9762\u7684\u95ee\u9898\uff0c\u6709\u4ec0\u4e48\u60f3\u95ee\u7684\u5417\uff1f";else if(!E)r="\u60a8\u597d\uff01\u6211\u662fAI\u517b\u751f\u52a9\u624b\u3002\u76ee\u524d\u60a8\u4f7f\u7528\u7684\u662f\u901a\u7528\u517b\u751f\u52a9\u624b\u3002\u5b8c\u6210\u6d4b\u8bc4\u540e\u5373\u53ef\u4f53\u9a8c\u4e2a\u4eba\u8ba2\u5236\u52a9\u624b\u3002\u6211\u53ef\u4ee5\u4e3a\u60a8\u89e3\u7b54\u5173\u4e8e\u4e2d\u533b\u4f53\u8d28\u3001\u5065\u5eb7\u8c03\u7406\u7b49\u65b9\u9762\u7684\u95ee\u9898\uff0c\u6709\u4ec0\u4e48\u60f3\u95ee\u7684\u5417\uff1f";else r="\u60a8\u597d\uff01\u6211\u662fAI\u517b\u751f\u52a9\u624b\u3002\u6839\u636e\u60a8\u7684\u6d4b\u8bc4\u7ed3\u679c\uff0c\u60a8\u7684\u4f53\u8d28\u7c7b\u578b\u662f".concat(E,"\u3002\u6211\u53ef\u4ee5\u4e3a\u60a8\u89e3\u7b54\u5173\u4e8e\u4f53\u8d28\u3001\u8c03\u7406\u3001\u5065\u5eb7\u7b49\u65b9\u9762\u7684\u95ee\u9898\uff0c\u6709\u4ec0\u4e48\u60f3\u95ee\u7684\u5417\uff1f");d([{role:"assistant",content:r}])}},[E,s.length]);var k=function(){var txt=typeof y==="string"?y:"";if(!txt.trim()||S)return;var e=g(f().m(function e(){var n,t,r,a,o,c;return f().w(function(e){while(1)switch(e.p=e.n){case 0:if(txt.trim()&&!S){e.n=1;break}return e.a(2);case 1:return n={role:"user",content:txt.trim()},t=[].concat(m(s),[n]),d(t),v(""),N(!0),e.p=2,e.n=3,A.mutateAsync({messages:t.map(function(e){return{role:e.role,content:e.content}}),bodyType:E||void 0,secondaryType:K||void 0,age:H||void 0,gender:X||void 0,fullReport:V||void 0});case 3:r=e.v,d([].concat(m(t),[{role:"assistant",content:r.content||(r.data&&r.data.content)}])),(function(){function findSQ(o,d){if(!o||(d|0)>6)return null;if(Array.isArray(o)&&o[0])return findSQ(o[0],d+1);if(o.suggestedQuestions&&Array.isArray(o.suggestedQuestions))return o.suggestedQuestions;if(typeof o==="object"){for(var k in o){var v=findSQ(o[k],d+1);if(v)return v;}}return null;}var list=(findSQ(r,0)||[]).slice(0,4);if(list.length===0&&r&&(r.content||(r.data&&r.data.content))){list=["针对我的年龄，有哪些建议？","针对我的体质，平时要注意什么？","像我这种情况，饮食有什么讲究？","我平时最需要留意什么？"];}if(list.length>0){Z(list);}})(),e.n=5;break;case 4:e.p=4,c=e.v,console.error("AI\u5bf9\u8bdd\u5931\u8d25:",c),o="\u53d1\u9001\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5",null!==c&&void 0!==c&&c.message?o=c.message:null!==c&&void 0!==c&&null!==(a=c.data)&&void 0!==a&&a.message?o=c.data.message:"string"===typeof c&&(o=c),o.includes("request:fail")||o.includes("url not in domain")?o="\u65e0\u6cd5\u8fde\u63a5\u5230\u670d\u52a1\u5668\uff0c\u8bf7\u68c0\u67e5:\n1. \u540e\u7aef\u670d\u52a1\u662f\u5426\u8fd0\u884c\n2. \u662f\u5426\u5173\u95ed\u4e86\u57df\u540d\u6821\u9a8c (\u5fae\u4fe1\u5f00\u53d1\u8005\u5de5\u5177 \u2192 \u8be6\u60c5 \u2192 \u672c\u5730\u8bbe\u7f6e)":o.includes("AI\u670d\u52a1")||o.includes("\u4f59\u989d\u4e0d\u8db3")||o.includes("Balance")?o="AI\u670d\u52a1\u6682\u65f6\u4e0d\u53ef\u7528\n\n\u53ef\u80fd\u539f\u56e0:\n1. \u8d26\u6237\u4f59\u989d\u4e0d\u8db3\n2. API\u5bc6\u94a5\u914d\u7f6e\u9519\u8bef\n\n\u8bf7\u67e5\u770b\u540e\u7aef\u65e5\u5fd7\u6216\u8fd0\u884c pnpm test-ai-chat \u8bca\u65ad":(o.includes("\u65e0\u6cd5\u8fde\u63a5")||o.includes("\u8fde\u63a5\u5931\u8d25"))&&(o="\u65e0\u6cd5\u8fde\u63a5\u5230\u670d\u52a1\u5668\n\n\u8bf7\u68c0\u67e5:\n1. \u540e\u7aef\u670d\u52a1\u662f\u5426\u8fd0\u884c (\u8fd0\u884c pnpm dev)\n2. \u7aef\u53e3\u914d\u7f6e\u662f\u5426\u6b63\u786e\n3. \u662f\u5426\u5173\u95ed\u4e86\u57df\u540d\u6821\u9a8c"),i().showToast({title:o,icon:"none",duration:3e3}),d(s);case 5:return e.p=5,N(!1),e.f(5);case 6:return e.a(2)}},e,null,[[2,4,5,6]])}));return function(){return e.apply(this,arguments)}}(),P=["\u9488\u5bf9\u6211\u7684\u5e74\u9f84\uff0c\u6709\u54ea\u4e9b\u5efa\u8bae\uff1f","\u9488\u5bf9\u6211\u7684\u4f53\u8d28\uff0c\u5e73\u65f6\u8981\u6ce8\u610f\u4ec0\u4e48\uff1f","\u50cf\u6211\u8fd9\u79cd\u60c5\u51b5\uff0c\u996e\u98df\u6709\u4ec0\u4e48\u8bb2\u7a76\uff1f","\u6211\u5e73\u65f6\u6700\u9700\u8981\u7559\u610f\u4ec0\u4e48\uff1f"],Y=function(e){v(e)};return(0,l.jsxs)(o.Ss,{className:"ai-chat-page",children:[(0,l.jsxs)(o.Ss,{className:"chat-header",children:[(0,l.jsx)(o.EY,{className:"chat-title",children:"AI\u517b\u751f\u52a9\u624b"}),E&&(0,l.jsxs)(o.EY,{className:"chat-subtitle",children:["\u60a8\u7684\u4f53\u8d28\uff1a",E]})]}),(0,l.jsx)(o.BM,{ref:w,className:"chat-messages",scrollY:!0,scrollIntoView:"message-".concat(s.length-1),children:(0,l.jsxs)(o.Ss,{className:"messages-container",children:[s.map(function(e,n){return(0,l.jsx)(o.Ss,{id:"message-".concat(n),className:"message-item ".concat("user"===e.role?"user":"assistant"),children:(0,l.jsx)(o.Ss,{className:"message-content",children:(0,l.jsx)(o.EY,{className:"message-text",children:e.content})})},n)}),S&&(0,l.jsx)(o.Ss,{className:"message-item assistant",children:(0,l.jsx)(o.Ss,{className:"message-content",children:(0,l.jsxs)(o.Ss,{className:"loading-dots",children:[(0,l.jsx)(o.EY,{className:"dot",children:"\xb7"}),(0,l.jsx)(o.EY,{className:"dot",children:"\xb7"}),(0,l.jsx)(o.EY,{className:"dot",children:"\xb7"})]})})})]})}),(0,l.jsxs)(o.Ss,{className:"quick-questions",children:[(0,l.jsx)(o.EY,{className:"quick-title",children:"\u5e38\u89c1\u95ee\u9898\uff1a"}),(0,l.jsx)(o.Ss,{className:"quick-list",children:(U.length>0?U:P).map(function(e,n){return(0,l.jsx)(o.Ss,{className:"quick-item",onClick:function(){return Y(e)},children:(0,l.jsx)(o.EY,{className:"quick-text",children:e})},n)})})]}),(0,l.jsxs)(o.Ss,{className:"chat-input-area",children:[(0,l.jsx)(o.pd,{className:"chat-input",type:"text",placeholder:"\u8f93\u5165\u60a8\u7684\u95ee\u9898...",value:y!=null?y:"",onInput:function(e){var val=e&&e.detail&&e.detail.value;v(val!=null?val:"");},confirmType:"send",onConfirm:k}),(0,l.jsx)(o.$n,{className:"send-button",onClick:k,disabled:S,children:S?"\u53d1\u9001\u4e2d":"\u53d1\u9001"})]}),(0,l.jsx)(o.EY,{className:"ai-disclaimer",children:"\u672c\u670d\u52a1\u4e3aAI\u751f\u6210\u5185\u5bb9\uff0c\u7ed3\u679c\u4ec5\u4f9b\u53c2\u8003\u3002\u591a\u95ee\u591a\u7b54\uff0c\u6b22\u8fce\u7ee7\u7eed\u63d0\u95ee\u3002"})]})}var T={navigationBarTitleText:"AI\u517b\u751f\u52a9\u624b"};Page((0,r.createPageConfig)(A,"pages/ai-chat/index",{root:{cn:[]}},T||{}))}},function(e){var n=function(n){return e(e.s=n)};e.O(0,[907,96,76],function(){return n(6276)});e.O()}]);