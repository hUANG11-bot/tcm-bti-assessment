# 快速重新部署指南（已配置 GitHub）

## 📋 当前状态

- ✅ GitHub 仓库已配置：`hUANG11-bot/tcm-bti-assessment`
- ✅ 微信云托管已绑定 GitHub 仓库
- ✅ 需要重新部署更新后的代码

---

## 🚀 快速操作步骤

### 步骤1：提交代码到 GitHub

#### 方法A：使用 Cursor 图形界面（推荐）

1. **打开源代码管理**：
   - 按 `Ctrl+Shift+G`
   - 或点击左侧的源代码管理图标

2. **查看更改的文件**：
   - 您会看到修改的文件，包括：
     - `server/api/wechat-login.ts`（已修改）
     - `src/lib/cookie.ts`（新文件）
     - `src/lib/trpc.ts`（已修改）
     - `src/pages/profile/index.tsx`（已修改）
     - `src/hooks/useAuth.ts`（已修改）

3. **暂存所有更改**：
   - 点击 **"+"** 按钮（暂存所有更改）
   - 或点击每个文件旁边的 **"+"** 按钮

4. **提交更改**：
   - 在消息框中输入：`修复：在登录响应中返回 sessionToken，添加 cookie 管理功能`
   - 点击 **"✓"** 按钮（提交）

5. **推送到 GitHub**：
   - 点击 **"..."** 菜单（三个点）
   - 选择 **"Push"** → **"Push to..."**
   - 选择 `origin` 和 `main`（或 `master`）分支
   - 等待推送完成

---

#### 方法B：使用命令行

在 PowerShell 或 Cursor 终端中执行：

```powershell
cd d:\tcm-bti-assessment

# 检查状态
git status

# 添加所有更改
git add .

# 提交更改
git commit -m "修复：在登录响应中返回 sessionToken，添加 cookie 管理功能"

# 推送到 GitHub
git push origin main
```

**如果使用 master 分支**：

```powershell
git push origin master
```

---

### 步骤2：触发重新部署

#### 方式A：自动部署（如果已配置）

**如果微信云托管已配置自动部署**：

1. ✅ **代码推送到 GitHub 后，会自动触发部署**
2. ⏱️ **等待 1-2 分钟**，部署会自动开始
3. 📊 **在微信云托管控制台查看部署进度**

---

#### 方式B：手动触发部署

**如果未配置自动部署，需要手动触发**：

1. **登录微信云托管控制台**：
   - 访问：https://mp.weixin.qq.com
   - 进入：**云服务** → **云开发** → **云托管**
   - 选择服务：`tci`

2. **进入"部署发布"页面**：
   - 点击 **"部署发布"** 标签

3. **确认配置**：
   - **选择方式**：绑定 GitHub 仓库 ✅
   - **代码仓库**：`hUANG11-bot/tcm-bti-assessment` ✅
   - **分支**：`main`（或 `master`）✅
   - **端口**：`3000` ✅

4. **点击"发布"按钮**：
   - 点击绿色的 **"发布"** 按钮
   - 等待部署开始

---

### 步骤3：等待部署完成

1. **查看部署进度**：
   - 在"部署发布"页面查看最新的部署记录
   - 状态会显示：
     - 🔄 **构建中**：正在构建 Docker 镜像
     - 🔄 **部署中**：正在部署到云托管
     - ✅ **成功**：部署完成
     - ❌ **失败**：部署失败，需要查看日志

2. **通常需要 5-10 分钟**

---

### 步骤4：验证部署

1. **检查服务状态**：
   - 进入"服务管理"页面
   - 确认服务状态：**正常**
   - 确认实例数量：**至少 1 个**
   - 确认运行状态：**Running**

2. **查看服务日志**：
   - 点击"运行日志"标签
   - 确认服务已启动
   - 查看是否有错误信息

---

### 步骤5：测试小程序

1. **重新编译小程序**：
   ```powershell
   cd d:\tcm-bti-assessment
   npm run build:weapp
   ```

2. **清除缓存**：
   - 打开微信开发者工具
   - 点击"编译"按钮旁边的下拉箭头
   - 选择"清除缓存" → "清除所有缓存"

3. **重新编译**：
   - 点击"编译"按钮
   - 等待编译完成

4. **测试登录功能**：
   - 打开"我的"页面
   - 点击"微信一键登录"
   - 查看是否成功
   - 查看控制台日志，确认没有 `401` 错误

5. **测试 AI 功能**：
   - 完成测评后进入 AI 咨询页面
   - 发送测试消息（例如："你好"）
   - 查看是否能正常收到 AI 回复

---

## ⚠️ 重要提示

### 1. 如果推送失败

**可能原因**：
- 需要先拉取远程更改
- 本地分支与远程分支不同步

**解决方法**：

```powershell
# 先拉取远程更改
git pull origin main

# 如果有冲突，解决冲突后再推送
git add .
git commit -m "解决冲突"
git push origin main
```

---

### 2. 如果部署失败

**查看部署日志**：

1. 在"部署发布"页面
2. 点击失败的部署记录
3. 点击"查看日志"
4. 查看详细错误信息
5. 根据错误信息进行修复

**常见问题**：
- 构建失败 → 检查 Dockerfile
- 依赖安装失败 → 检查 package.json
- 文件缺失 → 确认所有文件已提交到 GitHub

---

### 3. 环境变量配置

**如果部署后服务无法启动**：

1. 进入：**服务设置** → **环境变量**
2. 确认以下环境变量已配置：
   - `WX_APPID`
   - `WX_SECRET`
   - `AI_PROVIDER`
   - `AI_API_KEY`
   - `JWT_SECRET`
   - `DATABASE_URL`
   - `NODE_ENV=production`
   - `PORT=3000`
3. **保存后重启服务**

---

## ✅ 总结

**重新部署的完整流程**：

1. ✅ 提交代码到 GitHub（`git add .` → `git commit` → `git push`）
2. ✅ 触发部署（自动或手动点击"发布"）
3. ✅ 等待部署完成（5-10 分钟）
4. ✅ 验证服务状态
5. ✅ 测试小程序功能

**后续更新**：
- 只需重复步骤1和步骤2
- 如果配置了自动部署，只需推送代码即可

---

## 🎉 完成！

部署成功后，小程序应该能够正常登录和使用 AI 功能了！
