# 排查登录连接超时问题

## 🔍 问题诊断

从错误信息可以看到：
- `POST https://er1.store/api/wechat/login net::ERR_CONNECTION_TIMED_OUT`
- 说明小程序无法连接到后端服务器

---

## 🚀 解决步骤

### 步骤1：检查后端服务状态

1. **登录微信云托管控制台**：
   - 访问：https://mp.weixin.qq.com
   - 进入：**云服务** → **云开发** → **云托管**
   - 选择服务：`tci`

2. **查看服务状态**：
   - 进入"服务管理"或"服务设置"页面
   - 检查以下信息：
     - ✅ **服务状态**：应该显示"正常"
     - ✅ **实例数量**：应该至少 1 个
     - ✅ **运行状态**：应该显示"Running"

3. **如果服务状态不正常**：
   - 服务状态显示"异常"或"停止"
   - 实例数量为 0
   - 运行状态不是"Running"
   
   **解决方法**：
   - 点击"重启服务"按钮
   - 等待服务重启完成

---

### 步骤2：查看后端日志

1. **点击"运行日志"标签**

2. **查看最新的日志**：
   - 查看是否有错误信息
   - 查看服务是否正常启动
   - 查找以下关键词：
     - `Server running on`
     - `Error`
     - `Failed`
     - `WX_SECRET is not configured`

3. **确认服务已启动**：
   - 应该看到类似 `Server running on http://localhost:3000/` 的日志
   - 如果没有，说明服务未正常启动

---

### 步骤3：测试域名访问

在浏览器中测试：

1. **访问**：`https://er1.store/api/wechat/login`
   - 如果返回错误（如 400、500），说明服务运行中，但接口有问题
   - 如果连接超时或无法访问，说明服务未运行或域名配置有问题

2. **访问**：`https://er1.store`
   - 如果无法访问，说明域名或服务有问题

---

### 步骤4：检查部署状态

1. **进入"部署发布"页面**

2. **查看最新的部署记录**：
   - 确认最新部署是否成功
   - 如果部署失败，需要重新部署

3. **如果部署失败**：
   - 点击失败的部署记录
   - 查看详细日志
   - 根据错误信息修复问题

---

### 步骤5：检查环境变量

确认以下环境变量已配置：

```
WX_APPID=wx04a7af67c8f47620
WX_SECRET=您的AppSecret（必须配置！）
AI_PROVIDER=deepseek
AI_API_KEY=您的DeepSeek API密钥
JWT_SECRET=您的JWT密钥
DATABASE_URL=您的数据库连接字符串
NODE_ENV=production
PORT=3000
```

---

### 步骤6：重启服务

如果服务状态正常但仍有问题：

1. **在"服务设置"页面**
2. **点击"重启服务"按钮**
3. **等待重启完成**（通常 1-2 分钟）
4. **再次测试登录功能**

---

## 🔧 常见问题

### 问题1：服务未运行

**症状**：
- 服务状态显示"异常"或"停止"
- 实例数量为 0

**解决方法**：
1. 检查部署是否成功
2. 查看部署日志，找出失败原因
3. 修复问题后重新部署
4. 或点击"重启服务"

---

### 问题2：服务运行但无法访问

**症状**：
- 服务状态显示"正常"
- 但浏览器无法访问 `https://er1.store`

**可能原因**：
- 域名配置问题
- SSL 证书问题
- 防火墙或安全组配置

**解决方法**：
1. 检查自定义域名配置
2. 确认 SSL 证书已正确部署
3. 检查安全组规则

---

### 问题3：环境变量未配置

**症状**：
- 服务运行但返回 500 错误
- 日志显示 `WX_SECRET is not configured`

**解决方法**：
1. 在"服务设置"中添加 `WX_SECRET` 环境变量
2. 保存配置
3. 重启服务

---

## ✅ 检查清单

- [ ] 服务状态：正常
- [ ] 实例数量：至少 1 个
- [ ] 运行状态：Running
- [ ] 日志显示服务已启动
- [ ] `WX_SECRET` 环境变量已配置
- [ ] 所有必需的环境变量都已配置
- [ ] 已重启服务
- [ ] 浏览器可以访问 `https://er1.store`

---

## 🎯 下一步

完成以上检查后：

1. **如果服务未运行**：修复部署问题或重启服务
2. **如果服务运行但无法访问**：检查域名和 SSL 配置
3. **如果服务运行且可访问**：检查环境变量配置

完成后告诉我结果，我会继续帮您排查。
