# 重新部署后端指南

## 📋 概述

由于修改了后端代码（`server/api/wechat-login.ts`），需要重新部署到微信云托管。

---

## 🚀 方式1：手动上传代码包（推荐）

### 步骤1：构建后端代码

在 PowerShell 中执行：

```powershell
cd d:\tcm-bti-assessment
npm run build
```

**或者使用 pnpm：**

```powershell
cd d:\tcm-bti-assessment
pnpm build
```

**等待构建完成**，确认没有错误。

---

### 步骤2：创建部署压缩包

在 PowerShell 中执行：

```powershell
cd d:\tcm-bti-assessment
Compress-Archive -Path dist,server,shared,package.json,pnpm-lock.yaml,Dockerfile -DestinationPath deploy.zip -Force
```

**或者手动创建：**

1. 在文件管理器中进入 `d:\tcm-bti-assessment`
2. 选择以下文件和文件夹：
   - ✅ `dist` 文件夹
   - ✅ `server` 文件夹
   - ✅ `shared` 文件夹
   - ✅ `package.json` 文件
   - ✅ `pnpm-lock.yaml` 文件
   - ✅ `Dockerfile` 文件
3. 右键点击 → **发送到** → **压缩(zipped)文件夹**
4. 重命名为 `deploy.zip`

---

### 步骤3：登录微信云托管控制台

1. **访问**：https://mp.weixin.qq.com
2. **登录您的微信公众平台账号**
3. **进入**：**云服务** → **云开发** → **云托管**
4. **选择您的服务**（例如：`tci` 或 `Zhongyiti`）

---

### 步骤4：上传代码包

1. **点击"部署发布"标签**
2. **选择"上传代码包"方式**（如果显示"绑定 GitHub 仓库"，查找切换选项）
3. **点击"选择文件"或"上传"按钮**
4. **选择** `d:\tcm-bti-assessment\deploy.zip`
5. **等待上传完成**

---

### 步骤5：配置部署设置

1. **设置端口**：
   - 找到"端口"输入框
   - 设置为 `3000`

2. **检查环境变量**（如果需要）：
   - 展开"高级设置"（如果有）
   - 确认环境变量已配置：
     ```
     WX_APPID=wx04a7af67c8f47620
     WX_SECRET=您的AppSecret
     AI_PROVIDER=deepseek
     AI_API_KEY=您的DeepSeek密钥
     JWT_SECRET=您的JWT密钥
     DATABASE_URL=您的数据库连接字符串
     NODE_ENV=production
     PORT=3000
     ```

**注意**：如果上传时无法配置环境变量，可以在部署后到"服务设置"中配置。

---

### 步骤6：发布部署

1. **点击"发布"或"部署"按钮**
2. **等待部署完成**（通常需要 5-10 分钟）
3. **查看部署日志**，确认部署成功

---

### 步骤7：验证部署

1. **查看服务状态**：
   - 应该显示"服务正常"、"运行中"

2. **查看日志**：
   - 点击"日志"标签
   - 查看是否有错误信息
   - 确认服务已启动

3. **测试 API**：
   - 在浏览器访问：`https://er1.store/api/health`（如果有健康检查接口）
   - 或等待小程序测试

---

## 🔄 方式2：GitHub 自动部署（详细步骤）

### 📋 前置条件检查

**在开始之前，确认以下配置：**

1. ✅ **GitHub 仓库已创建**：`您的用户名/tcm-bti-assessment`
2. ✅ **代码已推送到 GitHub**
3. ✅ **微信云托管已授权 GitHub 访问**

---

### 步骤1：配置 GitHub 授权（如果未配置）

#### 1.1 登录微信云托管控制台

1. **访问**：https://mp.weixin.qq.com
2. **登录您的微信公众平台账号**
3. **进入**：**云服务** → **云开发** → **云托管**
4. **选择您的服务**（例如：`tci`）

---

#### 1.2 完成 GitHub 授权

1. **进入"部署发布"页面**
2. **如果看到红色提示"代码权限未授权或授权过期"**：
   - 点击提示中的 **"点击授权"** 链接
   - 页面会跳转到 GitHub 授权页面

3. **在 GitHub 授权页面**：
   - 登录您的 GitHub 账号（如果未登录）
   - 确认授权微信云托管访问您的仓库
   - **选择要授权的仓库范围**：
     - 选项1：**所有仓库**（推荐，最简单）
     - 选项2：**仅选择特定仓库**（更安全）
       - 选择：`您的用户名/tcm-bti-assessment`

4. **点击"授权"或"Approve"按钮**

5. **授权成功后**：
   - 自动返回微信云托管页面
   - 红色提示消失
   - "代码仓库"下拉菜单可以正常使用

---

### 步骤2：配置 GitHub 仓库绑定（如果未配置）

#### 2.1 选择部署方式

1. **在"部署发布"页面**
2. **选择"绑定 GitHub 仓库"方式**
   - 如果显示"上传代码包"，查找切换选项
   - 通常有"选择方式"或"部署方式"的切换按钮

---

#### 2.2 选择代码仓库

1. **点击"代码仓库"下拉菜单**
   - 现在应该可以看到您的 GitHub 仓库列表

2. **选择您的项目仓库**：
   - 找到：`您的用户名/tcm-bti-assessment`
   - 例如：`hUANG11-bot/tcm-bti-assessment`

3. **确认选择**
   - 选择后，仓库名称会显示在下拉菜单中

---

#### 2.3 选择分支

1. **点击"分支"下拉菜单**
   - 选择代码仓库后，这里会显示该仓库的所有分支

2. **选择要部署的分支**：
   - 通常选择：`main`（主分支）
   - 如果使用 `master` 分支，选择 `master`
   - 如果使用其他分支（如 `dev`、`production`），选择对应的分支

3. **确认选择**
   - 选择后，分支名称会显示在下拉菜单中

---

#### 2.4 设置端口

1. **找到"端口"输入框**
   - 默认可能显示 `80`

2. **修改为 `3000`**：
   - 清空当前的端口号
   - 输入：`3000`
   - 这是您的 Node.js 后端服务监听的端口

3. **确认输入**
   - 确保输入框显示为 `3000`

**为什么是 3000？**
- 您的服务器代码默认监听 3000 端口
- 云托管会通过环境变量 `PORT` 传递端口号
- 为了确保正确，建议明确设置为 `3000`

---

#### 2.5 高级设置（可选）

**如果需要配置环境变量**：

1. **展开"高级设置"**（如果有）
   - 点击"高级设置"展开配置选项

2. **配置环境变量**（可选，也可以在部署后配置）：
   ```env
   WX_APPID=wx04a7af67c8f47620
   WX_SECRET=您的AppSecret
   AI_PROVIDER=deepseek
   AI_API_KEY=您的DeepSeek密钥
   JWT_SECRET=您的JWT密钥
   DATABASE_URL=您的数据库连接字符串
   NODE_ENV=production
   PORT=3000
   ```

**注意**：
- 如果"高级设置"中没有环境变量配置，可以在部署后到"服务设置"中配置
- 环境变量也可以在部署完成后配置（见步骤5）

---

### 步骤3：提交代码到 GitHub

#### 3.1 检查 Git 状态

在 PowerShell 中执行：

```powershell
cd d:\tcm-bti-assessment
git status
```

**查看是否有未提交的更改**。

---

#### 3.2 添加更改到暂存区

```powershell
git add .
```

**或者只添加特定文件**：

```powershell
git add server/api/wechat-login.ts
git add src/lib/cookie.ts
git add src/lib/trpc.ts
git add src/pages/profile/index.tsx
git add src/hooks/useAuth.ts
```

---

#### 3.3 提交更改

```powershell
git commit -m "修复：在登录响应中返回 sessionToken 供小程序使用，添加 cookie 管理功能"
```

**提交信息说明**：
- 描述了本次修改的主要内容
- 方便以后查看历史记录

---

#### 3.4 推送到 GitHub

**如果使用 main 分支**：

```powershell
git push origin main
```

**如果使用 master 分支**：

```powershell
git push origin master
```

**如果首次推送**：

```powershell
git push -u origin main
```

**等待推送完成**，确认没有错误。

---

### 步骤4：触发自动部署

#### 4.1 方式A：自动触发（如果已配置）

**如果微信云托管已配置自动部署**：

1. **代码推送到 GitHub 后**，微信云托管会自动检测到更新
2. **自动开始部署**（通常需要 1-2 分钟开始）
3. **在"部署发布"页面可以看到新的部署任务**

---

#### 4.2 方式B：手动触发部署

**如果未配置自动部署，需要手动触发**：

1. **进入微信云托管控制台**
2. **进入"部署发布"页面**
3. **点击"发布"或"部署"按钮**
4. **确认配置**：
   - 代码仓库：`您的用户名/tcm-bti-assessment`
   - 分支：`main` 或 `master`
   - 端口：`3000`
5. **点击"确认"或"发布"**

---

### 步骤5：等待部署完成

#### 5.1 查看部署进度

1. **在"部署发布"页面**
2. **查看最新的部署记录**
3. **查看部署状态**：
   - 🔄 **构建中**：正在构建 Docker 镜像
   - 🔄 **部署中**：正在部署到云托管
   - ✅ **成功**：部署完成
   - ❌ **失败**：部署失败，需要查看日志

**通常需要 5-10 分钟**。

---

#### 5.2 查看部署日志

**如果部署失败**：

1. **点击部署记录**
2. **点击"查看日志"**
3. **查看详细错误信息**：
   - 构建错误
   - 依赖安装错误
   - 文件缺失错误
   - 其他错误

**根据错误信息进行修复**。

---

### 步骤6：配置环境变量（如果未配置）

**如果部署时未配置环境变量**：

1. **进入"服务设置"页面**
2. **找到"环境变量"选项**
3. **添加以下环境变量**：

   ```env
   WX_APPID=wx04a7af67c8f47620
   WX_SECRET=您的AppSecret
   AI_PROVIDER=deepseek
   AI_API_KEY=您的DeepSeek密钥
   JWT_SECRET=您的JWT密钥
   DATABASE_URL=您的数据库连接字符串
   NODE_ENV=production
   PORT=3000
   ```

4. **保存配置**

5. **重启服务**：
   - 点击"重启服务"按钮
   - 等待重启完成

---

### 步骤7：验证部署

#### 7.1 检查服务状态

1. **进入"服务管理"页面**
2. **查看服务状态**：
   - ✅ **服务状态**：正常
   - ✅ **实例数量**：至少 1 个
   - ✅ **运行状态**：Running

---

#### 7.2 查看服务日志

1. **点击"日志"标签**
2. **查看服务日志**：
   - 确认服务已启动
   - 查看是否有错误信息
   - 确认数据库连接成功
   - 确认 AI 服务配置正确

---

#### 7.3 测试 API（可选）

**在浏览器中测试**：

1. **访问**：`https://er1.store/api/health`（如果有健康检查接口）
2. **或访问**：`https://er1.store/api/wechat/login`（应该返回错误，但说明服务运行中）

---

### 步骤8：测试小程序

#### 8.1 重新编译小程序

1. **清除小程序缓存**：
   - 打开微信开发者工具
   - 点击"编译"按钮旁边的下拉箭头
   - 选择"清除缓存" → "清除所有缓存"

2. **重新编译**：
   ```powershell
   cd d:\tcm-bti-assessment
   npm run build:weapp
   ```

---

#### 8.2 测试登录功能

1. **在小程序中打开"我的"页面**
2. **点击"微信一键登录"**
3. **查看是否成功**
4. **查看控制台日志**：
   - 确认没有 `401` 错误
   - 确认 cookie 已保存
   - 确认登录成功

---

#### 8.3 测试 AI 功能

1. **完成测评后进入 AI 咨询页面**
2. **发送测试消息**（例如："你好"）
3. **查看是否能正常收到 AI 回复**

---

## ⚠️ 重要提示

### 1. 自动部署配置

**如何配置自动部署**：

1. **在微信云托管控制台**
2. **进入"服务设置"**
3. **找到"自动部署"或"持续集成"选项**
4. **启用自动部署**：
   - 选择触发条件（如：推送到 main 分支）
   - 保存配置

**配置后，每次推送到指定分支都会自动触发部署**。

---

### 2. 部署失败处理

**如果部署失败**：

1. **查看部署日志**，找到具体错误
2. **常见问题**：
   - Dockerfile 有问题 → 检查 Dockerfile
   - 依赖安装失败 → 检查 package.json
   - 文件缺失 → 确认所有文件已提交到 GitHub
   - 环境变量缺失 → 配置环境变量

3. **修复后重新提交**：
   ```powershell
   git add .
   git commit -m "修复：解决部署问题"
   git push origin main
   ```

---

### 3. 回滚到之前的版本

**如果需要回滚**：

1. **在"部署发布"页面**
2. **查看历史部署记录**
3. **找到之前的成功部署**
4. **点击"回滚"或"重新部署"**
5. **确认回滚**

**或者通过 Git 回滚**：

```powershell
git log  # 查看提交历史
git checkout <之前的提交hash>  # 切换到之前的提交
git push origin main --force  # 强制推送（谨慎使用）
```

---

### 4. 查看部署历史

**在微信云托管控制台**：

1. **进入"部署发布"页面**
2. **查看部署历史记录**：
   - 每次部署的提交信息
   - 部署时间
   - 部署状态
   - 部署日志

**可以追踪每次部署对应的代码版本**。

---

## ✅ 优势

**使用 GitHub 自动部署的优势**：

1. ✅ **自动化**：
   - 代码推送到 GitHub 后自动部署
   - 不需要手动上传文件

2. ✅ **版本控制**：
   - 每次部署都对应一个 Git 提交
   - 可以轻松追踪和回滚

3. ✅ **协作**：
   - 团队成员可以通过 GitHub 协作
   - 代码变更自动同步到部署

4. ✅ **CI/CD**：
   - 可以配置自动化测试
   - 可以配置自动化构建和部署流程

---

## 🎉 完成！

**部署成功后，小程序应该能够正常登录和使用 AI 功能了！**

**后续更新**：
- 只需提交代码到 GitHub
- 自动触发部署（如果已配置）
- 或手动点击"发布"按钮

---

## ⚠️ 重要提示

### 1. 环境变量配置

**如果部署后服务无法启动，检查环境变量：**

1. 进入：**服务设置** → **环境变量**
2. 确认以下环境变量已配置：
   - `WX_APPID`
   - `WX_SECRET`
   - `AI_PROVIDER`
   - `AI_API_KEY`
   - `JWT_SECRET`
   - `DATABASE_URL`
   - `NODE_ENV=production`
   - `PORT=3000`

3. **保存后重启服务**

---

### 2. 查看部署日志

**如果部署失败：**

1. 点击"部署发布" → 查看最新的部署记录
2. 点击"查看日志"，查看详细错误信息
3. 根据错误信息进行修复

---

### 3. 重启服务

**部署成功后，建议重启服务：**

1. 进入：**服务管理** → **服务设置**
2. 点击"重启服务"
3. 等待重启完成

---

## ✅ 部署完成后的验证

### 1. 检查服务状态

- ✅ 服务状态：**正常**
- ✅ 实例数量：**至少 1 个**
- ✅ 运行状态：**Running**

---

### 2. 测试登录接口

在小程序中：

1. 打开"我的"页面
2. 点击"微信一键登录"
3. 查看是否成功
4. 查看控制台日志，确认没有 `401` 错误

---

### 3. 测试 AI 功能

1. 完成测评后进入 AI 咨询页面
2. 发送测试消息（例如："你好"）
3. 查看是否能正常收到 AI 回复

---

## 🆘 如果遇到问题

### 问题1：部署失败

**可能原因：**
- Dockerfile 有问题
- 代码构建失败
- 环境变量未配置

**解决方法：**
1. 查看部署日志，找到具体错误
2. 检查 `Dockerfile` 是否正确
3. 确认 `dist/index.js` 文件存在
4. 检查环境变量配置

---

### 问题2：服务无法启动

**可能原因：**
- 环境变量缺失
- 数据库连接失败
- 端口配置错误

**解决方法：**
1. 查看服务日志，找到错误信息
2. 检查环境变量是否完整
3. 确认数据库连接字符串正确
4. 确认端口设置为 `3000`

---

### 问题3：小程序仍然出现 401 错误

**可能原因：**
- Cookie 未正确保存
- Cookie 未正确发送

**解决方法：**
1. 清除小程序缓存
2. 重新编译小程序
3. 重新登录
4. 查看控制台日志，确认 cookie 是否被发送

---

## 📞 需要帮助？

如果遇到问题，请提供：
1. 部署日志截图
2. 服务日志截图
3. 错误信息详情

---

## 🎉 完成！

部署成功后，小程序应该能够正常登录和使用 AI 功能了！
